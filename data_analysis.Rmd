---
title: "Protests Increase Donations to Federal Political Campaigns"
author: "Nick Pangakis and Dan Gillion"
output: 
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '4'
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
editor_options: 
  chunk_output_type: inline
---

# Overview - Data Analysis

Last Updated: 9.12.22

How do protests influence American political behavior? This project investigates how political protests affect an individual's willingness to donate money to a federal political campaign. In this markdown, I describe the data analyses associated with this project. 

The analyses below draws on various data tables:

1.  `protest_data.csv`, which includes all protest data required for the analysis.

2.  `fec_weekly_daily.csv`, which includes the number and amount of individual-level FEC donations made at the county-level, grouped by either week or day.

3.  `fec_2020_daily_full.csv`, which includes the number and amount of individual-level FEC donations made daily across the whole country --- grouped by various subgroupings.

\pagebreak

```{r setup}
knitr::opts_chunk$set(echo = TRUE, fig.width=8, fig.height=4, include=TRUE, eval=TRUE)
options(scipen = 0, digits = 3)  # controls base R output
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(tidyverse, RCurl, here,
               data.table, bit64, stringr,
               readxl, tidyr, usmap, zoo,
               lubridate, scales, fixest,
               gridExtra, rdd)
```

# Exploratory Data Analysis

## Plotting Protests

```{r }

# Load in protest data
protest_data_full <- fread("protest_data.csv")

# add in state and census region identifier
# Source: https://github.com/kjhealy/fips-codes
state_county_walkover <- fread("county_fips_master.csv") %>% 
  select(fips, state_abbr, division_name)

```

### Geographic Plot of Protests

```{r}
##### Plot Protest activity across the United States
# Data wrangling
protest_weekly_large <- protest_data_full %>% 
  filter(weekly == 1,large == 0) %>% 
  group_by(fips_code) %>% 
  summarise(n_total = sum(n)) %>% 
  rename(fips = fips_code) %>% 
  mutate(protest_count = log(n_total+1))
# Create Map
plot_usmap(regions = "counties",labels = F,                
    data = protest_weekly_large, exclude = c("Hawaii", "Alaska","DC"),
    values = "protest_count", color = "black") + 
    scale_fill_gradient(
      low = "white", high = "red", 
      name = "Protest Activity (log)", 
      label = scales::comma) + 
    labs(title = "Protest Activity By County (2017-2021)") +
    theme(legend.position = "right")
```

Protests tend to cluster in heavily populated, liberal, coastal regions.

```{r}
# Histogram of Logged Number of (large) Protests Over time
protest_data_full %>% 
  filter(weekly == 1,large == 1) %>% 
  group_by(fips_code) %>% 
  summarise(n_total = sum(n)) %>%
  mutate(protest_count = log(n_total+1)) %>% 
  ggplot() +
  geom_histogram(aes(x = protest_count), bins = 80, fill = "blue") +
  labs(title = "Distribution of Large Protests by County (2017-2021)", 
       x = "Logged Number of Protests in a County Overtime" , 
       y = "Number of Counties",
       caption = "Note: Protests include all protest events that involved more than 30 participants") 

```

Protests are rare events. The vast majority of counties do not have any (large) protests in the years 2017 to 2021. Large protests are defined as protests containing more than 30 people.

```{r}
# Histogram of Logged Number of Protests Over time (all protests)
protest_data_full %>% 
  filter(weekly == 1,large == 0, liberal == 0, conservative == 0, 
         onlyprotest == 0, norallies == 0, salient == 0) %>% 
  group_by(fips_code) %>% 
  summarise(n_total = sum(n)) %>%
  mutate(protest_count = log(n_total+1)) %>% 
  ggplot() +
  geom_histogram(aes(x = protest_count), bins = 80, fill = "blue") +
  labs(title = "Distribution of Total Protests by County (2017-2021)", 
       x = "Logged Number of Protests in a County Overtime" , 
       y = "Number of Counties") 

```

Even when examining all protests in the dataset, most counties had zero protest activity over time.

```{r}
# Histogram of  Number of Protests Over time by party (all protests)
plot_liberal <- protest_data_full %>% 
  filter(weekly == 1,large == 0, liberal == 1, conservative == 0, 
         onlyprotest == 0, norallies == 0, salient == 0) %>% 
  group_by(year) %>% 
  summarise(n_total = sum(n)) %>%
  ggplot(aes(x = as.factor(year), y = n_total, fill = "blue")) +
  geom_col() +
  labs(y = "Number of Protests",
       x = "Year",
       title = "Distribution of Liberal Protests by Year") +
  theme(legend.position="none") +
  scale_fill_manual(values = "blue") +
  scale_y_continuous(limits = c(0, 8000))

# Histogram of  Number of Protests Over time by party (all protests)
plot_conservative <- protest_data_full %>% 
  filter(weekly == 1,large == 0, liberal == 0, conservative == 1, 
         onlyprotest == 0, norallies == 0, salient == 0) %>% 
  group_by(year) %>% 
  summarise(n_total = sum(n)) %>%
  ggplot(aes(x = as.factor(year), y = n_total, fill = "blue")) +
  geom_col() +
  labs(y = "Number of Protests",
       x = "Year",
       title = "Distribution of Conservative Protests by Year") +
  theme(legend.position="none") +
  scale_fill_manual(values = "red") +
  scale_y_continuous(limits = c(0, 8000))

# arrange plots together
grid.arrange(plot_liberal, plot_conservative, nrow=2)
```
Liberal protests are far more common than conservative protests. Liberal protests were far more common in 2018 and 2020. 2018 has far more protests because A) January Women's Marches across the country and B) March for Our Lives gun control marches. 2020 has far more protests because of the BLM protests surrounded the killing of George Floyd.

```{r}
# Data wrangling
protest_weekly_region <- protest_data_full %>% 
  left_join(state_county_walkover, by = c("fips_code"="fips")) %>% 
  filter(weekly == 1, large == 1) %>% 
  group_by(fips_code, division_name) %>% 
  summarise(n_total = sum(n))
# Summary statistics of protests by week
summary(protest_weekly_region$n_total)
(quantiles_protest <- quantile(protest_weekly_region$n_total, probs = seq(0, 1, 1/20)))
nrow(protest_weekly_region[protest_weekly_region$n_total==0,])/nrow(protest_weekly_region)

protest_weekly_region %>% 
  # examine only the top 10 percent of counties
  filter(n_total >= quantiles_protest[[19]]) %>% 
  ggplot(aes(x = forcats::fct_reorder(as.factor(fips_code), n_total, .desc = FALSE), y = n_total, fill = division_name)) +
  geom_col() +
  labs(y = "Number of Protests",
       x = "County (Grouped by Census Region)",
       title = "Distribution of Large Protests by County (Top 10th Percentile of Protest Activity Only)",
       caption = "Note: Protests include all protest events that involved more than 30 participants") +
  theme(axis.text.y = element_blank()) +
  scale_fill_discrete(name = "Census Region") +
  coord_flip()

```

Some counties have significant protest activity, whereas 50.4 percent of counties do not have any (large) protests. 

### Temporal Plot of Protests

```{r}
# Protests over time

##### Add in date and time information
protest_data_overtime <- protest_data_full %>% 
  left_join(state_county_walkover, by = c("fips_code"="fips")) %>% 
  filter(weekly == 0,large == 1) %>% 
  group_by(date) %>% 
  summarise(n_total = sum(n)) %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d"),
         year = as.factor(year(date)),
         yearmonth = as.factor(as.yearmon(date)),
         month = as.character(month(date)),
         month = dplyr::recode(month, "1" = "Jan.",
                              "2" = "Feb.",
                              "3" = "March",
                              "4" = "April",
                              "5" = "May",
                              "6" = "June",
                              "7" = "July",
                              "8" = "Aug.",
                              "9" = "Sept.",
                              "10" = "Oct.",
                              "11" = "Nov.",
                              "12" = "Dec."),
         month = factor(month, levels = c("Jan.",
                                          "Feb.",
                                          "March",
                                          "April",
                                          "May",
                                          "June",
                                          "July",
                                          "Aug.",
                                          "Sept.",
                                          "Oct.",
                                          "Nov.",
                                          "Dec.")),
         startdate = "2017-01-01",
         startdate = as.Date(startdate, format = "%Y-%m-%d"),
         week = as.numeric(ceiling(difftime(date, startdate, units = "weeks")))+1,
         weekdays = as.character(weekdays(date)),
         weekdays = factor(weekdays, levels = c("Monday",
                                          "Tuesday",
                                          "Wednesday",
                                          "Thursday",
                                          "Friday",
                                          "Saturday",
                                          "Sunday")),
         # Manually handle outlier (women's protest on 2018-03-14)
         n_total = case_when(as.character(date) == "2018-03-14" ~ sort(n_total,
                                                                       TRUE)[2],
                              TRUE ~ n_total))

library(plyr)
# Create monthweek variable
protest_data_overtime <- plyr::ddply(protest_data_overtime, 
                                     .(yearmonth), transform, 
                                     monthweek = 1 + week - min(week))
detach("package:plyr")

##### Create grouping function

calendar_plot <- function(title, fill, data) {
  plot <- ggplot(data, aes(monthweek, weekdays, fill = n_total)) +
    geom_tile(colour = "white") +
    facet_grid(year ~ month) +
    scale_fill_gradient(low = "white", high = "red") +
    labs(
      x = "Week of Month",
      y = "",
      title = title,
      fill = fill,
      caption = caption
    )
}

wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = "\n")
}

title <- "Protest Activity Over Time"
fill <- "# of Protests"
caption = wrapper("Note: The number of protests on March 14th, 2018 is actually 3,620 because of the nationwide gun reform protests. For data visualization purposes, I treat this observation as an outlier and replace its value with the second highest number of protests, which is 631.", width = 80)
plot <- calendar_plot(title, fill, protest_data_overtime)
plot
```

Significant spike in protest activity following the police killing of George Floyd in 2020 (May 25th, 2020). Moreover, 2020 has more protest activity than any other year.

```{r}
# Protests over time

##### Add in date and time information
protest_data_overtime_2018 <- protest_data_full %>% 
  left_join(state_county_walkover, by = c("fips_code"="fips")) %>% 
  filter(weekly == 0,large == 1) %>% 
  mutate(year = substr(date, 1, 4)) %>% 
  filter(year == "2018") %>% 
  group_by(date) %>% 
  summarise(n_total = sum(n)) %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d"),
         year = as.factor(year(date)),
         yearmonth = as.factor(as.yearmon(date)),
         month = as.character(month(date)),
         month = dplyr::recode(month, "1" = "Jan.",
                              "2" = "Feb.",
                              "3" = "March",
                              "4" = "April",
                              "5" = "May",
                              "6" = "June",
                              "7" = "July",
                              "8" = "Aug.",
                              "9" = "Sept.",
                              "10" = "Oct.",
                              "11" = "Nov.",
                              "12" = "Dec."),
         month = factor(month, levels = c("Jan.",
                                          "Feb.",
                                          "March",
                                          "April",
                                          "May",
                                          "June",
                                          "July",
                                          "Aug.",
                                          "Sept.",
                                          "Oct.",
                                          "Nov.",
                                          "Dec.")),
         startdate = "2017-01-01",
         startdate = as.Date(startdate, format = "%Y-%m-%d"),
         week = as.numeric(ceiling(difftime(date, startdate, units = "weeks")))+1,
         weekdays = as.character(weekdays(date)),
         weekdays = factor(weekdays, levels = c("Monday",
                                          "Tuesday",
                                          "Wednesday",
                                          "Thursday",
                                          "Friday",
                                          "Saturday",
                                          "Sunday")),
         # Manually handle outlier (women's protest on 2018-03-14)
         n_total = case_when(as.character(date) == "2018-03-14" ~ sort(n_total,
                                                                       TRUE)[2],
                              TRUE ~ n_total))

##### Add in date and time information
protest_data_overtime_2020 <- protest_data_full %>% 
  left_join(state_county_walkover, by = c("fips_code"="fips")) %>% 
  filter(weekly == 0,large == 1) %>% 
  mutate(year = substr(date, 1, 4)) %>% 
  filter(year == "2020") %>% 
  group_by(date) %>% 
  summarise(n_total = sum(n)) %>%
  mutate(date = as.Date(date, format = "%Y-%m-%d"),
         year = as.factor(year(date)),
         yearmonth = as.factor(as.yearmon(date)),
         month = as.character(month(date)),
         month = dplyr::recode(month, "1" = "Jan.",
                              "2" = "Feb.",
                              "3" = "March",
                              "4" = "April",
                              "5" = "May",
                              "6" = "June",
                              "7" = "July",
                              "8" = "Aug.",
                              "9" = "Sept.",
                              "10" = "Oct.",
                              "11" = "Nov.",
                              "12" = "Dec."),
         month = factor(month, levels = c("Jan.",
                                          "Feb.",
                                          "March",
                                          "April",
                                          "May",
                                          "June",
                                          "July",
                                          "Aug.",
                                          "Sept.",
                                          "Oct.",
                                          "Nov.",
                                          "Dec.")),
         startdate = "2017-01-01",
         startdate = as.Date(startdate, format = "%Y-%m-%d"),
         week = as.numeric(ceiling(difftime(date, startdate, units = "weeks")))+1,
         weekdays = as.character(weekdays(date)),
         weekdays = factor(weekdays, levels = c("Monday",
                                          "Tuesday",
                                          "Wednesday",
                                          "Thursday",
                                          "Friday",
                                          "Saturday",
                                          "Sunday")),
         # Manually handle outlier (women's protest on 2018-03-14)
         n_total = case_when(as.character(date) == "2018-03-14" ~ sort(n_total,
                                                                       TRUE)[2],
                              TRUE ~ n_total))

library(plyr)
# Create monthweek variable
protest_data_overtime_2018 <- plyr::ddply(protest_data_overtime_2018, 
                                     .(yearmonth), transform, 
                                     monthweek = 1 + week - min(week))

# Create monthweek variable
protest_data_overtime_2020 <- plyr::ddply(protest_data_overtime_2020, 
                                     .(yearmonth), transform, 
                                     monthweek = 1 + week - min(week))
detach("package:plyr")

# plot
caption <- NULL
title <- "Protest Activity 2018"
fill <- "# of Protests"
plot_2018 <- calendar_plot(title, fill, protest_data_overtime_2018)
title <- "Protest Activity 2020"
plot_2020 <- calendar_plot(title, fill, protest_data_overtime_2020)

# arrange plots together
grid.arrange(plot_2018, plot_2020, nrow=2)
```
2018 protest activity is largely driven by A) January Women's Marches across the coutnry and B) March for Our Lives gun control marches. 2020 protest activity is driven by the BLM protests following the killing of George Floyd. It's also worth highlighting that protest activity is higher on Saturdays.

## Plotting FEC Donations

```{r}
# load all FEC data
fec_2020_daily_full <- fread("fec_2020_daily_full.csv")
fec_weekly_daily<- fread("fec_weekly_daily.csv")

```

### Geographic Plots of FEC Donations

```{r}
fec_weekly_daily %>%
  filter(week_id == 0, is.na(R), is.na(D), !is.na(number_donations)) %>% 
  left_join(state_county_walkover, by = c("COUNTY"="fips")) %>%
  select(number_donations, state_abbr, COUNTY, division_name) %>% 
  group_by(state_abbr, COUNTY ,division_name) %>% 
  summarise(number_donations = sum(number_donations)) %>% 
  drop_na() %>% 
  ggplot(aes(x = forcats::fct_reorder(as.factor(state_abbr), 
                                      number_donations,
                                      .fun = mean,.desc = TRUE), 
             y = number_donations, 
             group=state_abbr,
             fill = division_name)) +
  geom_boxplot() +
  labs(title = "Weekly Donation Variation Within and Between States (2017-2021)", x = "State (Grouped By Census Region)" , y = "Number of Weekly Donations by County") +
  theme(legend.position = "None",
        axis.text.x = element_text(
          angle = 90,
          vjust = 0.5,
          hjust = 1)) 
```

Data might require log transformation, due to significant outliers.

```{r}
# Campaign contributions across states
# LOGGED
fec_weekly_daily %>%
  filter(week_id == 0, is.na(R), is.na(D), !is.na(number_donations)) %>% 
  left_join(state_county_walkover, by = c("COUNTY"="fips")) %>%
  select(number_donations, state_abbr, COUNTY, division_name) %>% 
  group_by(state_abbr, COUNTY ,division_name) %>% 
  summarise(number_donations = sum(number_donations)) %>% 
  drop_na() %>% 
  ggplot(aes(x = forcats::fct_reorder(as.factor(state_abbr), 
                                      log(number_donations+1),
                                      .fun = mean,.desc = TRUE), 
             y = log(number_donations+1), 
             group=state_abbr,
             fill = division_name)) +
  geom_boxplot() +
  labs(title = "Weekly Logged Donation Variation Within and Between States (2017-2021)", x = "State (Grouped By Census Region)" , y = "Number of Logged Weekly Donations by County") +
  theme(legend.position = "None",
        axis.text.x = element_text(
          angle = 90,
          vjust = 0.5,
          hjust = 1)) 
```

# Data Wrangling for Analysis

```{r}
# remove unnecessary dataframes
rm(plot, protest_data_overtime, protest_weekly_large, 
   protest_weekly_region, fill, quantiles_protest, title,
   state_county_walkover, calendar_plot, plot_2018, plot_2020, 
   plot_conservative, plot_liberal, protest_data_overtime_2018,
   protest_data_overtime_2020)
```

```{r}
# Load in protest data
protest_data_full <- fread("protest_data.csv")

# add in state and census region identifier
# Source: https://github.com/kjhealy/fips-codes
state_county_walkover <- fread("county_fips_master.csv") %>% 
  select(fips, state_abbr, division_name)

# load all FEC data
fec_2020_daily_full <- fread("fec_2020_daily_full.csv")
fec_weekly_daily<- fread("fec_weekly_daily.csv")

```


## Preprocess Protest Data

```{r}
### Primary Protest Datasets

# 1) `protest_weekly_all`: The number of weekly protests that occur in an American county for every year from 2017 to 2021 (ID is weekly = 1).
protest_weekly_all <- protest_data_full %>% 
  filter(weekly == 1, large == 0, liberal == 0, conservative == 0,
         onlyprotest == 0, norallies == 0, salient == 0)

# 2) `protest_daily_all`: The number of daily protests that occur in an American county for every year from 2017 to 2021 (ID is weekly = 0).
protest_daily_all <- protest_data_full %>%
  filter(weekly == 0, large == 0, liberal == 0, conservative == 0,
         onlyprotest == 0, norallies == 0, salient == 0)

# 3) `protest_weekly_large`: Subset of `protest_weekly_all` that limits to protests that include more than 30 people (ID is weekly = 1 and large = 1). 
protest_weekly_large <- protest_data_full %>% 
  filter(weekly == 1, large == 1, liberal == 0, conservative == 0,
         onlyprotest == 0, norallies == 0, salient == 0)

# 4) `protest_daily_large` is the same as `protest_weekly_large` but with daily protest data (ID is weekly = 0 and large = 1).
protest_daily_large <- protest_data_full %>%
  filter(weekly == 0, large == 1, liberal == 0, conservative == 0,
         onlyprotest == 0, norallies == 0, salient == 0)

# 5) `protest_grouped_week_liberal`: Subset of `protest_weekly_all` that limits to protests that include more than 30 people and are labeled as liberal protests (ID is weekly = 1 and liberal = 1). 
protest_grouped_week_liberal <- protest_data_full %>% 
  filter(weekly == 1, large == 0, liberal == 1, conservative == 0,
         onlyprotest == 0, norallies == 0, salient == 0)

# 6) `protest_grouped_daily_liberal` is the same as `protest_grouped_week_liberal` but with daily data (ID is weekly = 0 and liberal = 1).
protest_grouped_daily_liberal <- protest_data_full %>%
  filter(weekly == 0, large == 0, liberal == 1, conservative == 0,
         onlyprotest == 0, norallies == 0, salient == 0)

# 7) `protest_grouped_week_conservative`: Subset of `protest_weekly_all` that limits to protests that include more than 30 people and are labeled as conservative protests (ID is weekly = 1 and conservative = 1).
protest_grouped_week_conservative <- protest_data_full %>% 
  filter(weekly == 1, large == 0, liberal == 0, conservative == 1,
         onlyprotest == 0, norallies == 0, salient == 0)

# 8) `protest_grouped_daily_conservative` is the same as `protest_grouped_week_conservative` but daily data (ID is weekly = 0 and conservative = 1).
protest_grouped_daily_conservative <- protest_data_full %>%
  filter(weekly == 0, large == 0, liberal == 0, conservative == 1,
         onlyprotest == 0, norallies == 0, salient == 0)

### Supplemental dataframes: 

# 9) `protest_weekly_onlyprotests`: Subset of `protest_weekly_all` that limits to protests that include more than 30 people and only includes protest activities explicitly labeled as "protests." (ID is weekly = 1 and onlyprotest = 1). 
protest_weekly_onlyprotests <- protest_data_full %>% 
  filter(weekly == 1, large == 0, liberal == 0, conservative == 0,
         onlyprotest == 1, norallies == 0, salient == 0)

# 10) `protest_daily_onlyprotests` is the same as `protest_weekly_onlyprotests` but daily (ID is weekly = 0 and onlyprotest = 1).
protest_daily_onlyprotests <- protest_data_full %>%
  filter(weekly == 0, large == 0, liberal == 0, conservative == 0,
         onlyprotest == 1, norallies == 0, salient == 0)

# 11) `protest_weekly_norallies`: Subset of `protest_weekly_all` that limits to protests that include more than 30 people and excludes any protest activities explicitly labeled as "rallies." (ID is weekly = 1 and norallies = 1).
protest_weekly_norallies <- protest_data_full %>% 
  filter(weekly == 1, large == 0, liberal == 0, conservative == 0,
         onlyprotest == 0, norallies == 1, salient == 0)

# 12) `protest_daily_norallies` is the same as `protest_weekly_norallies` but daily (ID is weekly = 0 and norallies = 1).
protest_daily_norallies <- protest_data_full %>%
  filter(weekly == 0, large == 0, liberal == 0, conservative == 0,
         onlyprotest == 0, norallies == 1, salient == 0)


# 13) `protest_weekly_salient`: Subset of `protest_weekly_all` that limits to protests that include more than 30 people and only includes protest activities resulting in an arrest, property damage, or injuries. (ID is weekly = 1 and salient = 1).
protest_weekly_salient <- protest_data_full %>% 
  filter(weekly == 1, large == 0, liberal == 0, conservative == 0,
         onlyprotest == 0, norallies == 0, salient == 1)

# 14) `protest_daily_salient` is the same as `protest_weekly_salient` but daily (ID is weekly = 0 and salient = 1).
protest_daily_salient <- protest_data_full %>%
  filter(weekly == 0, large == 0, liberal == 0, conservative == 0,
         onlyprotest == 0, norallies == 0, salient == 1)

```

## Preprocess FEC Data

### Subset FEC Data

```{r}
# 1) number and amount of weekly donations by county
# Number of donations
fec_total_weekly_county <- fec_weekly_daily %>% 
  filter(week_id == 1, is.na(amount_donations), 
         is.na(R), is.na(D)) %>% 
  select(date, COUNTY, year, number_donations)
# Amount of donations (combined with number of donations)
fec_total_weekly_county <- fec_weekly_daily %>% 
  filter(week_id == 1, is.na(number_donations), 
         is.na(R), is.na(D)) %>% 
  select(date, COUNTY, year, amount_donations) %>% 
  left_join(fec_total_weekly_county, by = c("date", "COUNTY", "year"))

# 2) number and amount of donations by week per county made to Republicans
fec_total_weekly_county_R <- fec_weekly_daily %>% 
  filter(week_id == 1, !is.na(R), is.na(D)) %>% 
  select(date, COUNTY, year, number_donations, amount_donations)

# 3) number and amount of donations by week per county made to Democrats
fec_total_weekly_county_D <- fec_weekly_daily %>% 
  filter(week_id == 1, is.na(R), !is.na(D)) %>% 
  select(date, COUNTY, year, number_donations, amount_donations)

# 4) number and amount of daily donations by county
# Number of donations
fec_total_daily_county <- fec_weekly_daily %>%
  filter(week_id == 0, is.na(amount_donations),
         is.na(R), is.na(D)) %>%
  select(date, COUNTY, year, number_donations)
# Amount of donations (combined with number of donations)
fec_total_daily_county <- fec_weekly_daily %>%
  filter(week_id == 0, is.na(number_donations),
         is.na(R), is.na(D)) %>%
  select(date, COUNTY, year, amount_donations) %>%
  left_join(fec_total_daily_county, by = c("date", "COUNTY", "year"))

# 5) number and amount of donations daily per county made to Republicans
fec_total_daily_county_R <- fec_weekly_daily %>%
  filter(week_id == 0, !is.na(R), is.na(D))

# 6) number and amount of donations daily per county made to Democrats
fec_total_daily_county_D <- fec_weekly_daily %>%
  filter(week_id == 0, is.na(R), !is.na(D))

```

# Analysis I: RDD and IV

```{r}
# Subset daily donation data
number_daily_donations_full <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations), is.na(republican), is.na(democrat), 
         is.na(incumbent), is.na(white), is.na(number_donations_standardized), 
         is.na(amount_donations_standardized), is.na(challenger), is.na(africanamerican)) %>% 
  arrange(days) %>% 
  select(days, after, number_donations) %>% 
  # Restrict data to 90 days before and 90 days after the killing
  filter(days > -91 & days < 91)

amount_daily_donations_full <- fec_2020_daily_full %>% 
  filter(is.na(number_donations), is.na(republican), is.na(democrat), 
         is.na(incumbent), is.na(white), is.na(number_donations_standardized), 
         is.na(amount_donations_standardized), is.na(challenger), is.na(africanamerican)) %>% 
  arrange(days) %>% 
  select(days, after, amount_donations) %>% 
  # Restrict data to 90 days before and 90 days after the killing
  filter(days > -91 & days < 91)
```


### Window Plot - Donation Amount

```{r}
##### Visualize regression coefficients over varying windows
windows <- seq(5,90, by=1)
mat <- matrix(NA, nrow = 86, ncol = 4)
for (i in 1:length(windows)){
  # create varying subset to run regression
  sub_dta <- subset(amount_daily_donations_full,
                    days > 0 - windows[i] & days < 0 + windows[i])
  # fit linear model
  lout_sub <- summary(lm(amount_donations ~ days + I(days > 0), 
                         data=sub_dta))
  # extract necessary coefficients
  coefficient <- round(lout_sub$coefficients[[3]], 3)
  se <- round(lout_sub$coefficients[[3,2]], 3)
  pvalue <- round(lout_sub$coefficients[[3,4]], 3)
  # add coefficients to plot
  mat[i,1] <- windows[i]
  mat[i,2] <- coefficient
  mat[i,3] <- se
  mat[i,4] <- pvalue
}
colnames(mat) <- c("window_size","coefficient","se","pvalue")
plot_coef <- data.frame(mat)
plot_coef <- plot_coef %>% 
  mutate(significant = case_when(pvalue < 0.051 ~ 1, TRUE ~ 0)) %>% 
  drop_na()

# Calculate optimal bandwidth
bw_amount <- IKbandwidth(X = amount_daily_donations_full$days, 
                        Y = amount_daily_donations_full$amount_donations, cutpoint = 0)
bw_amount_dta <-subset(amount_daily_donations_full, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Number (optimal)
lout_optimal <- lm(amount_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(mat[mat[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient,color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       #caption = "Figure 3",
       subtitle = "The Effect of Political Protests on Donation Behavior") +
  ylab("Increase in Federal Donations") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 63 Days Coefficient: $8,052,911, P-Value: 0.018",46), 
    x=63,
    y=18000000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

All are positively signed. 54 out of 86 bandwidths show statistically significant increases. 

### Window Plot - Donation Number

```{r}
##### Visualize regression coefficients over varying windows
windows <- seq(5,90, by=1)
mat <- matrix(NA, nrow = 86, ncol = 4)
for (i in 1:length(windows)){
  # create varying subset to run regression
  sub_dta <- subset(number_daily_donations_full,
                    days > 0 - windows[i] & days < 0 + windows[i])
  # fit linear model
  lout_sub <- summary(lm(number_donations ~ days + I(days > 0), 
                         data=sub_dta))
  # extract necessary coefficients
  coefficient <- round(lout_sub$coefficients[[3]], 3)
  se <- round(lout_sub$coefficients[[3,2]], 3)
  pvalue <- round(lout_sub$coefficients[[3,4]], 3)
  # add coefficients to plot
  mat[i,1] <- windows[i]
  mat[i,2] <- coefficient
  mat[i,3] <- se
  mat[i,4] <- pvalue
}
colnames(mat) <- c("window_size","coefficient","se","pvalue")
plot_coef <- data.frame(mat)
plot_coef <- plot_coef %>% 
  mutate(significant = case_when(pvalue < 0.051 ~ 1, TRUE ~ 0)) %>% 
  drop_na()

# Calculate optimal bandwidth
bw_count <- IKbandwidth(X = number_daily_donations_full$days, 
                        Y = number_daily_donations_full$number_donations, cutpoint = 0)
bw_count_dta <-subset(number_daily_donations_full, days > 0 - bw_count & days < 0 + bw_count)
# Full Data - Number (optimal)
lout_optimal <- lm(number_donations ~ days + I(days > 0), data = bw_count_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_count), 1, 0)

# number of significant window sizes
nrow(mat[mat[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient,color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1L,big.mark = ",")) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       #caption = "Figure 3",
       subtitle = "The Effect of Political Protests on Donation Behavior") +
  ylab("Increase in Number of Federal Donations") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 68 Days Coefficient: 23,394, P-Value: 0.27",46), 
    x=68,
    y=83000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

30 out of 86 bandwidths show statistically significant increases. 

### Varying Thresholds - Amount of donations 

```{r}
# Subset daily donation data
number_daily_donations <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations), is.na(republican), is.na(democrat), 
         is.na(incumbent), is.na(white), is.na(number_donations_standardized), 
         is.na(amount_donations_standardized), is.na(challenger), is.na(africanamerican)) %>% 
  arrange(days) %>% 
  select(days, after, number_donations)

amount_daily_donations <- fec_2020_daily_full %>% 
  filter(is.na(number_donations), is.na(republican), is.na(democrat), 
         is.na(incumbent), is.na(white), is.na(number_donations_standardized), 
         is.na(amount_donations_standardized), is.na(challenger), is.na(africanamerican)) %>% 
  arrange(days) %>% 
  select(days, after, amount_donations) 
```


```{r}
threshold <- seq(-70,70, by=1)
threshold_ls <- vector()
coef_ls <- vector()
pvalue_ls <- vector()
se_ls <- vector()
for (i in 1:length(threshold)) {
  data <- amount_daily_donations %>% 
    filter(days > threshold[i] - 91 & days < threshold[i] + 91)
  bw_amount <- IKbandwidth(X = data$days,
                          Y = data$amount_donations,
                          cutpoint = threshold[i])
  sub_dta <-
    subset(data, days > threshold[i] - bw_amount & days < threshold[i] + bw_amount)
  lout_sub <-
    summary(lm(amount_donations ~ days + I(days > threshold[i]), data = sub_dta))
  coefficient <- round(lout_sub$coefficients[[3]], 3)
  se <- round(lout_sub$coefficients[[3, 2]], 3)
  pvalue <- round(lout_sub$coefficients[[3, 4]], 3)
  threshold_ls <- append(threshold_ls, threshold[i])
  coef_ls <- append(coef_ls, coefficient)
  pvalue_ls <- append(pvalue_ls, pvalue)
  se_ls <- append(se_ls, se)
}

mat <- matrix(NA, nrow = 141, ncol = 4)

for (i in 1:length(pvalue_ls)){
  mat[i, 1] <- threshold_ls[i]
  mat[i, 2] <- coef_ls[i]
  mat[i, 3] <- pvalue_ls[i]
  mat[i, 4] <- se_ls[i]
}

colnames(mat) <- c("threshold", "coefficient","pvalue","se")
plot_coef <- data.frame(mat)

plot_coef$significant <- 0

for (i in 1:nrow(plot_coef)) {
  if (plot_coef$coefficient[i] > 0) {
    plot_coef$significant[i] <-
      ifelse((plot_coef$coefficient[i] - (2 * plot_coef$se[i])) > 0, 1, plot_coef$significant[i])
  } else if (plot_coef$coefficient[i] < 0) {
    plot_coef$significant[i] <-
      ifelse((plot_coef$coefficient[i] + (2 * plot_coef$se[i])) < 0, 1, plot_coef$significant[i])
  }
}

# number of significant coefficients
sum(plot_coef$significant) # 23 out of 141
# number of positive significant coefficients
nrow(plot_coef[plot_coef[,"significant"] == 1 & plot_coef[,"coefficient"] > 0, ]) # 10 of of 141

# change x axis
xaxis <- seq.Date(as.IDate("2020-03-16"), as.IDate("2020-08-03"), by="days")

# Plot
ggplot(plot_coef, aes(x = xaxis, y = coefficient,color=as.factor(significant))) +
  geom_point(size = 1) +
  scale_color_manual(values = c("black","red")) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  theme(legend.position = "none") +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "blue") +
  geom_vline(xintercept = xaxis[71],
             linetype = "dotdash",
             color = "red") +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_date("Threshold", date_breaks = "1 month", date_labels =  "%b %Y") +
  labs(title = "Varying Thresholds:",
       caption = "Note: For every threshold, each model is fit using the Imbens-Kalyanaraman Optimal Bandwidth.",
       subtitle = "The Effect of Political Protests on Donation Behavior") +
  ylab("Increase in Federal Donations") +
   geom_label(
    label=str_wrap("May 25th, 2020, Police Killing of George Floyd",20), 
    x=xaxis[71],
    y=-15000000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

First increase: mid to late March in 2020, which is right when Covid lockdowns began. Second increase: mid-April 2020 is when Sanders drops out of Presidential Race and Biden becomes main Democratic candidate. Third increase is killing of George Floyd. Large decrease in late June and early July is plausibly the aftermath of increased donation behavior in the month prior. 

### Varying Thresholds - Number of donations 

```{r}
threshold <- seq(-70,70, by=1)
threshold_ls <- vector()
coef_ls <- vector()
pvalue_ls <- vector()
se_ls <- vector()
for (i in 1:length(threshold)) {
  data <- number_daily_donations %>% 
    filter(days > threshold[i] - 91 & days < threshold[i] + 91)
  bw_count <- IKbandwidth(X = data$days,
                          Y = data$number_donations,
                          cutpoint = threshold[i])
  sub_dta <-
    subset(data, days > threshold[i] - bw_count & days < threshold[i] + bw_count)
  lout_sub <-
    summary(lm(number_donations ~ days + I(days > threshold[i]), data = sub_dta))
  coefficient <- round(lout_sub$coefficients[[3]], 3)
  se <- round(lout_sub$coefficients[[3, 2]], 3)
  pvalue <- round(lout_sub$coefficients[[3, 4]], 3)
  threshold_ls <- append(threshold_ls, threshold[i])
  coef_ls <- append(coef_ls, coefficient)
  pvalue_ls <- append(pvalue_ls, pvalue)
  se_ls <- append(se_ls, se)
}

mat <- matrix(NA, nrow = 141, ncol = 4)

for (i in 1:length(pvalue_ls)){
  mat[i, 1] <- threshold_ls[i]
  mat[i, 2] <- coef_ls[i]
  mat[i, 3] <- pvalue_ls[i]
  mat[i, 4] <- se_ls[i]
}

colnames(mat) <- c("threshold", "coefficient","pvalue","se")
plot_coef <- data.frame(mat)

plot_coef$significant <- 0

for (i in 1:nrow(plot_coef)) {
  if (plot_coef$coefficient[i] > 0) {
    plot_coef$significant[i] <-
      ifelse((plot_coef$coefficient[i] - (2 * plot_coef$se[i])) > 0, 1, plot_coef$significant[i])
  } else if (plot_coef$coefficient[i] < 0) {
    plot_coef$significant[i] <-
      ifelse((plot_coef$coefficient[i] + (2 * plot_coef$se[i])) < 0, 1, plot_coef$significant[i])
  }
}

# number of significant coefficients
sum(plot_coef$significant)
# number of positive significant coefficients
nrow(plot_coef[plot_coef[,"significant"] == 1 & plot_coef[,"coefficient"] > 0, ]) 

# Plot
ggplot(plot_coef, aes(x = xaxis, y = coefficient,color=as.factor(significant))) +
  geom_point(size = 1) +
  scale_color_manual(values = c("black","red")) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  theme(legend.position = "none") +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1L,big.mark = ",")) +
  geom_vline(xintercept = xaxis[71],
             linetype = "dotdash",
             color = "red") +
  scale_x_date("Threshold", date_breaks = "1 month", date_labels =  "%b %Y") +
  labs(title = "Varying Thresholds:",
       caption = "Note: For every threshold, each model is fit using the Imbens-Kalyanaraman Optimal Bandwidth.",
       subtitle = "The Effect of Political Protests on Donation Behavior") +
  ylab("Increase in Number of Federal Donations") +
  geom_label(
    label=str_wrap("May 25th, 2020, Police Killing of George Floyd",20), 
    x=xaxis[71],
    y=-80000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```
### Robustness Check: Adding Polynomials

```{r}
##### Visualize regression coefficients over varying windows
windows <- seq(5,90, by=1)
mat <- matrix(NA, nrow = 86, ncol = 4)
for (i in 1:length(windows)){
  # create varying subset to run regression
  sub_dta <- subset(amount_daily_donations_full,
                    days > 0 - windows[i] & days < 0 + windows[i])
  # fit linear model - with added polynomial
  lout_sub <- summary(lm(amount_donations ~ days^2 + I(days > 0), 
                         data=sub_dta))
  # extract necessary coefficients
  coefficient <- round(lout_sub$coefficients[[3]], 3)
  se <- round(lout_sub$coefficients[[3,2]], 3)
  pvalue <- round(lout_sub$coefficients[[3,4]], 3)
  # add coefficients to plot
  mat[i,1] <- windows[i]
  mat[i,2] <- coefficient
  mat[i,3] <- se
  mat[i,4] <- pvalue
}
colnames(mat) <- c("window_size","coefficient","se","pvalue")
plot_coef <- data.frame(mat)
plot_coef <- plot_coef %>% 
  mutate(significant = case_when(pvalue < 0.051 ~ 1, TRUE ~ 0)) %>% 
  drop_na()

# Calculate optimal bandwidth
bw_amount <- IKbandwidth(X = amount_daily_donations_full$days, 
                        Y = amount_daily_donations_full$amount_donations, cutpoint = 0)
bw_amount_dta <-subset(amount_daily_donations_full, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Number (optimal)
lout_optimal <- lm(amount_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(mat[mat[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes (With Polynomial Term):",
       #caption = "Figure 3",
       subtitle = "The Effect of Political Protests on Donation Behavior")
  ylab("Increase in Federal Donations") +
  
```

### Subgroup Analysis:
```{r}
rm(data)
# function to analyze window plots
window_plot <- function(data, amount, std){
  ##### Visualize regression coefficients over varying windows
  windows <- seq(5,90, by=1)
  mat <- matrix(NA, nrow = 86, ncol = 4)
  for (i in 1:length(windows)){
    # create varying subset to run regression
    sub_dta <- subset(data,
                      days > 0 - windows[i] & days < 0 + windows[i])
    # fit linear model
    if (amount == TRUE & std == FALSE){
      lout_sub <- summary(lm(amount_donations ~ days + I(days > 0), 
                           data=sub_dta))
    } else if (amount == TRUE & std == TRUE){
      lout_sub <- summary(lm(amount_donations_standardized ~ 
                               days + I(days > 0), 
                             data=sub_dta))
    } else if (amount == FALSE & std == FALSE){
      lout_sub <- summary(lm(number_donations ~ 
                               days + I(days > 0), 
                             data=sub_dta))
    } else if (amount == FALSE & std == TRUE){
      lout_sub <- summary(lm(number_donations_standardized ~ 
                               days + I(days > 0), 
                             data=sub_dta))
    }
    # extract necessary coefficients
    coefficient <- round(lout_sub$coefficients[[3]], 3)
    se <- round(lout_sub$coefficients[[3,2]], 3)
    pvalue <- round(lout_sub$coefficients[[3,4]], 3)
    # add coefficients to plot
    mat[i,1] <- windows[i]
    mat[i,2] <- coefficient
    mat[i,3] <- se
    mat[i,4] <- pvalue
  }
  colnames(mat) <- c("window_size","coefficient","se","pvalue")
  plot_coef <- data.frame(mat)
  plot_coef <- plot_coef %>% 
    mutate(significant = case_when(pvalue < 0.051 ~ 1, TRUE ~ 0)) %>% 
    drop_na()

  return(plot_coef)
}
```

#### Democrats

```{r}
##### Preprocess data

# Democrats - amount
data_dem_amount <- fec_2020_daily_full %>% 
  filter(!is.na(amount_donations) & is.na(number_donations) & !is.na(democrat) & is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, amount_donations, democrat) %>% 
  filter(democrat == 1,
         days > -91 & days < 91) 

# Democrats - amount standardized
data_dem_amount_std <- fec_2020_daily_full %>% 
  filter(!is.na(amount_donations_standardized) & !is.na(amount_donations) & is.na(number_donations) & !is.na(democrat) & is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, amount_donations_standardized, democrat) %>% 
  filter(democrat == 1,
         days > -91 & days < 91) 

# Democrats - number 
data_dem_num <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations) & !is.na(number_donations) & !is.na(democrat) & is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, number_donations, democrat) %>% 
  filter(democrat == 1,
         days > -91 & days < 91) 

# Democrats - number standardized
data_dem_num_std <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations) & !is.na(number_donations) & !is.na(democrat) & is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, number_donations_standardized, democrat) %>% 
  filter(democrat == 1,
         days > -91 & days < 91)

```

```{r}
##### Amount
plot_coef <- window_plot(data_dem_amount, TRUE, FALSE)

# optimal
bw_amount <- IKbandwidth(X = data_dem_amount$days,
                        Y = data_dem_amount$amount_donations, cutpoint = 0)
bw_amount_dta <-subset(data_dem_amount, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(amount_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Political Protests on Liberal Donation Behavior") +
  ylab("Increase in Federal Donations to Democrats") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 31 Days Coefficient: $2,617,291, P-Value: 0.004",46), 
    x=31,
    y=5500000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

69 of 85 windows significant. 

```{r}
##### Count
plot_coef <- window_plot(data_dem_num, FALSE,FALSE)

# optimal
bw_amount <- IKbandwidth(X = data_dem_num$days,
                        Y = data_dem_num$number_donations, cutpoint = 0)
bw_amount_dta <-subset(data_dem_num, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(number_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1L,
                                                    big.mark = ",")) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Political Protests on Liberal Donation Behavior") +
  ylab("Increase in Federal Donations to Democrats") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 81 Days Coefficient: 1790, P-Value: 0.7",46), 
    x=68,
    y=17000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

31 out of 90 significant

#### Republicans

```{r}
##### Preprocess data

# Rep - amount
data_rep_amount <- fec_2020_daily_full %>% 
  filter(!is.na(amount_donations) & is.na(number_donations) & is.na(democrat) & !is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, amount_donations, republican) %>% 
  filter(republican == 1,
         days > -91 & days < 91) 

# Rep - amount standardized
data_rep_amount_std <- fec_2020_daily_full %>% 
  filter(!is.na(amount_donations_standardized) & !is.na(amount_donations) & is.na(number_donations) & is.na(democrat) & !is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, amount_donations_standardized, republican) %>% 
  filter(republican == 1,
         days > -91 & days < 91) 

# Rep - number 
data_rep_num <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations) & !is.na(number_donations) & is.na(democrat) & !is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, number_donations, republican) %>% 
  filter(republican == 1,
         days > -91 & days < 91) 

# Rep - number standardized
data_rep_num_std <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations) & !is.na(number_donations) & is.na(democrat) & !is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, number_donations_standardized, republican) %>% 
  filter(republican == 1,
         days > -91 & days < 91)

```

```{r}
##### Amount
plot_coef <- window_plot(data_rep_amount, TRUE, FALSE)

# optimal
bw_amount <- IKbandwidth(X = data_rep_amount$days,
                        Y = data_rep_amount$amount_donations, cutpoint = 0)
bw_amount_dta <-subset(data_rep_amount, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(amount_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Political Protests on Conservative Donation Behavior") +
  ylab("Increase in Federal Donations to Republicans") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 32 Days Coefficient: $1,052,460, P-Value: 0.14",46), 
    x=32,
    y=4200000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

37 of 85 windows significant. 

```{r}
##### Count
plot_coef <- window_plot(data_rep_num, FALSE,FALSE)

# optimal
bw_amount <- IKbandwidth(X = data_rep_num$days,
                        Y = data_rep_num$number_donations, cutpoint = 0)
bw_amount_dta <-subset(data_rep_num, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(number_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1L,
                                                    big.mark = ",")) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Political Protests on Conservative Donation Behavior") +
  ylab("Increase in Federal Donations to Republicans") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 69 Days Coefficient: 5252, P-Value: 0.17",46), 
    x=68,
    y=17000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

23 out of 90 significant

#### Democrats v. Republicans

```{r}
##### Amount
plot_coef <- window_plot(data_dem_amount_std, TRUE, TRUE)

# optimal
bw_amount <- IKbandwidth(X = data_dem_amount_std$days,
                        Y = data_dem_amount_std$amount_donations_standardized, 
                        cutpoint = 0)
bw_amount_dta <-subset(data_dem_amount_std, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(amount_donations_standardized ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  #scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Protests on (Standardized) Liberal Donation Behavior") +
  ylab("Increase in Donations to Democrats")

```



```{r}
##### Amount Rep - std
plot_coef <- window_plot(data_rep_amount_std, TRUE, TRUE)

# optimal
bw_amount <- IKbandwidth(X = data_rep_amount_std$days,
                        Y = data_rep_amount_std$amount_donations_standardized, cutpoint = 0)
bw_amount_dta <-subset(data_rep_amount_std, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(amount_donations_standardized ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  # scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Protests on (Standardized) Conservative Donation Behavior") +
  ylab("Increase in Donations to Republicans") 
  # geom_label(
  #   label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 32 Days Coefficient: $1,052,460, P-Value: 0.14",46), 
  #   x=32,
  #   y=4200000,
  #   label.padding = unit(0.1, "lines"), # Rectangle size around label
  #   label.size = NA,
  #   color = "black",
  #   fill="#56B4E9",
  #   size = 2.5
  # )
```

#### Incumbent

```{r}
##### Preprocess data

# Incumbent - amount
data_inc_amount <- fec_2020_daily_full %>% 
  filter(!is.na(amount_donations) & is.na(number_donations) & is.na(democrat) & is.na(republican) & is.na(africanamerican) &
           !is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, amount_donations, incumbent) %>% 
  filter(incumbent == 1,
         days > -91 & days < 91) 

# Incumbent - amount standardized
data_inc_amount_std <- fec_2020_daily_full %>% 
  filter(!is.na(amount_donations_standardized) & !is.na(amount_donations) & is.na(number_donations) & is.na(democrat) & is.na(republican) & is.na(africanamerican) &
           !is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, amount_donations_standardized, incumbent) %>% 
  filter(incumbent == 1,
         days > -91 & days < 91) 

# Incumbent - number 
data_inc_num <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations) & !is.na(number_donations) & is.na(democrat) & is.na(republican) & is.na(africanamerican) &
           !is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, number_donations, incumbent) %>% 
  filter(incumbent == 1,
         days > -91 & days < 91) 

# Incumbent - number standardized
data_inc_num_std <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations) & !is.na(number_donations) & is.na(democrat) & is.na(republican) & is.na(africanamerican) &
           !is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, number_donations_standardized, incumbent) %>% 
  filter(incumbent == 1,
         days > -91 & days < 91)

```

```{r}
##### Amount
plot_coef <- window_plot(data_inc_amount, TRUE, FALSE)

# optimal
bw_amount <- IKbandwidth(X = data_inc_amount$days,
                        Y = data_inc_amount$amount_donations, cutpoint = 0)
bw_amount_dta <-subset(data_inc_amount, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(amount_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Political Protests on Donations to Incumbents") +
  ylab("Increase in Federal Donations to Incumbents") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 28 Days Coefficient: $2,769,262, P-Value: 0.002",46), 
    x=28,
    y=3500000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

65 of 85 windows significant. 

```{r}
##### Count
plot_coef <- window_plot(data_dem_num, FALSE,FALSE)

# optimal
bw_amount <- IKbandwidth(X = data_dem_num$days,
                        Y = data_dem_num$number_donations, cutpoint = 0)
bw_amount_dta <-subset(data_dem_num, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(number_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1L,
                                                    big.mark = ",")) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Political Protests on Liberal Donation Behavior") +
  ylab("Increase in Federal Donations to Democrats") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 81 Days Coefficient: 1790, P-Value: 0.7",46), 
    x=68,
    y=17000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

31 out of 90 significant

#### Challenger

```{r}
##### Preprocess data

# Rep - amount
data_rep_amount <- fec_2020_daily_full %>% 
  filter(!is.na(amount_donations) & is.na(number_donations) & is.na(democrat) & !is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, amount_donations, republican) %>% 
  filter(republican == 1,
         days > -91 & days < 91) 

# Rep - amount standardized
data_rep_amount_std <- fec_2020_daily_full %>% 
  filter(!is.na(amount_donations_standardized) & !is.na(amount_donations) & is.na(number_donations) & is.na(democrat) & !is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, amount_donations_standardized, republican) %>% 
  filter(republican == 1,
         days > -91 & days < 91) 

# Rep - number 
data_rep_num <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations) & !is.na(number_donations) & is.na(democrat) & !is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, number_donations, republican) %>% 
  filter(republican == 1,
         days > -91 & days < 91) 

# Rep - number standardized
data_rep_num_std <- fec_2020_daily_full %>% 
  filter(is.na(amount_donations) & !is.na(number_donations) & is.na(democrat) & !is.na(republican) & is.na(africanamerican) &
           is.na(incumbent) & is.na(challenger) & is.na(white) ) %>% 
  select(days, number_donations_standardized, republican) %>% 
  filter(republican == 1,
         days > -91 & days < 91)

```

```{r}
##### Amount
plot_coef <- window_plot(data_rep_amount, TRUE, FALSE)

# optimal
bw_amount <- IKbandwidth(X = data_rep_amount$days,
                        Y = data_rep_amount$amount_donations, cutpoint = 0)
bw_amount_dta <-subset(data_rep_amount, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(amount_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Political Protests on Conservative Donation Behavior") +
  ylab("Increase in Federal Donations to Republicans") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 32 Days Coefficient: $1,052,460, P-Value: 0.14",46), 
    x=32,
    y=4200000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

37 of 85 windows significant. 

```{r}
##### Count
plot_coef <- window_plot(data_rep_num, FALSE,FALSE)

# optimal
bw_amount <- IKbandwidth(X = data_rep_num$days,
                        Y = data_rep_num$number_donations, cutpoint = 0)
bw_amount_dta <-subset(data_rep_num, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(number_donations ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1L,
                                                    big.mark = ",")) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Political Protests on Conservative Donation Behavior") +
  ylab("Increase in Federal Donations to Republicans") +
  geom_label(
    label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 69 Days Coefficient: 5252, P-Value: 0.17",46), 
    x=68,
    y=17000,
    label.padding = unit(0.1, "lines"), # Rectangle size around label
    label.size = NA,
    color = "black",
    fill="#56B4E9",
    size = 2.5
  )
```

23 out of 90 significant

#### Incumbent v. Challenger

```{r}
##### Amount
plot_coef <- window_plot(data_dem_amount_std, TRUE, TRUE)

# optimal
bw_amount <- IKbandwidth(X = data_dem_amount_std$days,
                        Y = data_dem_amount_std$amount_donations_standardized, 
                        cutpoint = 0)
bw_amount_dta <-subset(data_dem_amount_std, days > 0 - bw_amount & days < 0 + bw_amount)
# Full Data - Amount (optimal)
lout_optimal <- lm(amount_donations_standardized ~ days + I(days > 0), data = bw_amount_dta)
summary(lout_optimal)

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
nrow(plot_coef[plot_coef[,"pvalue"] < 0.051,])

# Plot --------------------------------------------------------------------
ggplot(plot_coef, aes(x = window_size, y = coefficient, color=as.factor(optimal))) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  #scale_y_continuous(labels = scales::dollar_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(0, 90, by = 15)) +
  labs(title = "Varying Window Sizes:",
       subtitle = "The Effect of Protests on (Standardized) Liberal Donation Behavior") +
  ylab("Increase in Donations to Democrats")

```



# Analysis II: Diff-in-Diff (Week)

### Apply Transformations to FEC Data

```{r}
feature_transform <- function(protest_data, fec_data, daily){
  # Join Protest to FEC data
  if (daily == FALSE){
    data <- protest_data %>% 
      mutate(date = as.integer(date)) %>% 
      inner_join(fec_data, by = c("date", "fips_code" = "COUNTY", "year"))
      
  } else {
    data <- protest_data %>% 
      inner_join(fec_data, by = c("date", "fips_code" = "COUNTY"))
  }
  
  # 1) log DV
  fec_log_DV <- data %>%
    mutate(number_donations = log(number_donations+1),
           amount_donations = log(amount_donations+1))
  
  # 2) log log
  fec_log_log <- data %>% 
    mutate(n = log(n+1),
           number_donations = log(number_donations+1),
           amount_donations = log(amount_donations+1))
  
  # 3) Lag DV and IV
  fec_lag <- data %>% 
    group_by(fips_code) %>% 
    mutate(lag_week_protest = lag(n, order_by = fips_code),
           lag_week_donation_count = lag(number_donations, order_by = fips_code),
           lag_week_donation_amount = lag(amount_donations, order_by = fips_code)) %>% 
    ungroup() %>% 
    filter(date !=1)
  
  # 4) Lag Log DV and IV
  fec_lag_log_DV <- fec_log_DV %>% 
    group_by(fips_code) %>% 
    mutate(lag_week_protest = lag(n, order_by = fips_code),
           lag_week_donation_count = lag(number_donations, order_by = fips_code),
           lag_week_donation_amount = lag(amount_donations, order_by = fips_code)) %>% 
    ungroup() %>% 
    filter(date !=1)
  
  # 5) Lag Log DV and log IV
  fec_lag_log_log <- fec_log_log %>% 
    group_by(fips_code) %>% 
    mutate(lag_week_protest = lag(n, order_by = fips_code),
           lag_week_donation_count = lag(number_donations, order_by = fips_code),
           lag_week_donation_amount = lag(amount_donations, order_by = fips_code)) %>% 
    ungroup() %>% 
    filter(date !=1)

  # combine into list
  out <- list(data,
              fec_log_DV,
              fec_log_log,
              fec_lag,
              fec_lag_log_DV,
              fec_lag_log_log)
  return(out)
}

```

```{r}

run_regression <- function(data, number, lag){
  if (lag == FALSE & number == TRUE){
    model <- fixest::feols(number_donations ~ n | factor (fips_code) + factor(year) + factor(date), 
                         data = data)
  } else if (lag == FALSE & number == FALSE){
    model <- fixest::feols(amount_donations ~ n | factor (fips_code) + factor(year) + factor(date), 
                         data = data)
  } else if (lag == TRUE & number == TRUE) {
    model <- fixest::feols(number_donations ~ n + lag_week_donation_count + lag_week_protest | factor(fips_code) + factor(year) + factor(date), 
                         data = data)
  } else if (lag == TRUE & number == FALSE) {
    model <- fixest::feols(amount_donations ~ n + lag_week_donation_amount + lag_week_protest | factor(fips_code) + factor(year) + factor(date), 
                         data = data)
  }
  return(model)
}

# Create function to extract regression coefficients
return_coefficients <- function(input_mat, summary_data, model_rows, 
                                 model_type, var1, var2, var3, lag){
  input_mat[model_rows, 1] <- model_type
  input_mat[var1, 2] <- rownames(summary_data)[1]
  input_mat[var1, 3] <- round(summary_data[[1, 1]], 3)
  input_mat[var1, 4] <- round(summary_data[[1, 2]], 3)
  input_mat[var1, 5] <- round(summary_data[[1, 3]], 3)
  input_mat[var1, 6] <- round(summary_data[[1, 4]], 6)
  
  if (lag == TRUE){
    input_mat[var2, 2] <- rownames(summary_data)[2]
    input_mat[var2, 3] <- round(summary_data[[2, 1]], 3)
    input_mat[var2, 4] <- round(summary_data[[2, 2]], 3)
    input_mat[var2, 5] <- round(summary_data[[2, 3]], 3)
    input_mat[var2, 6] <- round(summary_data[[2, 4]], 6)
    input_mat[var3, 2] <- rownames(summary_data)[3]
    input_mat[var3, 3] <- round(summary_data[[3, 1]], 3)
    input_mat[var3, 4] <- round(summary_data[[3, 2]], 3)
    input_mat[var3, 5] <- round(summary_data[[3, 3]], 3)
    input_mat[var3, 6] <- round(summary_data[[3, 4]], 6)
  }
  return(input_mat)
}

analyze_data <- function(data_ls){
  
  # Initialize matrix to store coefficients
  mat <- matrix(nrow = 24, ncol = 6)
  
  ##### 1) Analysis on full data
  data_standard <- data_ls[[1]]
  # dv: number of donations
  model1_num <- run_regression(data_standard, TRUE, FALSE)
  model1_num_summary <- summary(model1_num)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Standard Model - Number of Donations"
  mat <- return_coefficients(mat, model1_num_summary, 1, 
                      model_type, 1, NULL, NULL, FALSE)
  # dv: amount of donations
  model1_amount <- run_regression(data_standard, FALSE, FALSE)
  model1_amount_summary <- summary(model1_amount)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Standard Model - Amount of Donations"
  mat <- return_coefficients(mat, model1_amount_summary, 2, 
                      model_type, 2, NULL, NULL, FALSE)
  
  ### 2) Analysis on data with logged DV
  data_dvlog <- data_ls[[2]]
  # dv: number of donations
  model2_num <- run_regression(data_dvlog, TRUE, FALSE)
  model2_num_summary <- summary(model2_num)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Logged DV - Number of Donations"
  mat <- return_coefficients(mat, model2_num_summary, 3, 
                      model_type, 3, NULL, NULL, FALSE)
  # dv: amount of donations
  model2_amount <- run_regression(data_dvlog, FALSE, FALSE)
  model2_amount_summary <- summary(model2_amount)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Logged DV - Amount of Donations"
  mat <- return_coefficients(mat, model2_amount_summary, 4, 
                      model_type, 4, NULL, NULL, FALSE)
  
  ### 3) Analysis on data with logged DV and logged IV
  data_loglog <- data_ls[[3]]
  # dv: number of donations
  model3_num <- run_regression(data_loglog, TRUE, FALSE)
  model3_num_summary <- summary(model3_num)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Log-log - Number of Donations"
  mat <- return_coefficients(mat, model3_num_summary, 5, 
                      model_type, 5, NULL, NULL, FALSE)
  # dv: amount of donations
  model3_amount <- run_regression(data_loglog, FALSE, FALSE)
  model3_amount_summary <- summary(model3_amount)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Log-log - Amount of Donations"
  mat <- return_coefficients(mat, model3_amount_summary, 6, 
                      model_type, 6, NULL, NULL, FALSE)
  
  ### 4) Analysis on data with lagged DV and IV --- MAIN MODEL
  data_lag <- data_ls[[4]]
  # dv: number of donations
  model4_num <- run_regression(data_lag, TRUE, TRUE)
  model4_num_summary <- summary(model4_num)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Lag - Number of Donations"
  mat <- return_coefficients(mat, model4_num_summary, 7:9, 
                      model_type, 7, 8, 9, TRUE)
  # dv: amount of donations
  model4_amount <- run_regression(data_lag, FALSE, TRUE)
  model4_amount_summary <- summary(model4_amount)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Lag - Amount of Donations"
  mat <- return_coefficients(mat, model4_amount_summary, 10:12, 
                      model_type, 10, 11, 12, TRUE)
  
  ### 5) Analysis on data with lagged DV and IV and log of DV
  data_lag_logDV <- data_ls[[5]]
  # dv: number of donations
  model5_num <- run_regression(data_lag_logDV, TRUE, TRUE)
  model5_num_summary <- summary(model5_num)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Lag log-DV - Number of Donations"
  mat <- return_coefficients(mat, model5_num_summary, 13:15, 
                      model_type, 13, 14, 15, TRUE)
  # dv: amount of donations
  model5_amount <- run_regression(data_lag_logDV, FALSE, TRUE)
  model5_amount_summary <- summary(model5_amount)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Lag log-DV - Amount of Donations"
  mat <- return_coefficients(mat, model5_amount_summary, 16:18, 
                      model_type, 16, 17, 18, TRUE)
  
  ### 6) Analysis on data with lagged DV and IV and log of DV and IV
  data_lag_loglog <- data_ls[[6]]
  # dv: number of donations
  model6_num <- run_regression(data_lag_loglog, TRUE, TRUE)
  model6_num_summary <- summary(model6_num)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Lag log-log - Number of Donations"
  mat <- return_coefficients(mat, model6_num_summary, 19:21, 
                      model_type, 19, 20, 21, TRUE)
  
  # dv: amount of donations
  model6_amount <- run_regression(data_lag_loglog, FALSE, TRUE)
  model6_amount_summary <- summary(model6_amount)[["coeftable"]]
  # extract coefficients from summary table
  model_type <- "Lag log-log - Amount of Donations"
  mat <- return_coefficients(mat, model6_amount_summary, 22:24, 
                      model_type, 22, 23, 24, TRUE)

  colnames(mat) <- c("Model Type", "Variable Name", "Effect Size", "SE", "T-Value", "P-Value")
  
  return(mat)
  
}

```


```{r}
# full protest data
data_all <- feature_transform(protest_weekly_all, fec_total_weekly_county, FALSE)
results_all <- analyze_data(data_all)

# large protests
data_large <- feature_transform(protest_weekly_large, fec_total_weekly_county, FALSE)
results_large <- analyze_data(data_large)

# only protests
data_protestsonly <- feature_transform(protest_weekly_onlyprotests, 
                                       fec_total_weekly_county, FALSE)
results_protestsonly <- analyze_data(data_protestsonly)

# no rallies
data_norallies <- feature_transform(protest_weekly_norallies, 
                                       fec_total_weekly_county, FALSE)
results_norallies <- analyze_data(data_norallies)

# salient
data_salient <- feature_transform(protest_weekly_salient, 
                                       fec_total_weekly_county, FALSE)
results_salient <- analyze_data(data_salient)


##### Same thing - no 2020
fec_no_2020 <- fec_total_weekly_county %>% 
  filter(year != 2020)
protest_no_2020 <- protest_weekly_all %>% 
  filter(year != 2020)
protest_large_no_2020 <- protest_weekly_large %>% 
  filter(year != 2020)


# full protest data
data_all_no2020 <- feature_transform(protest_no_2020, fec_no_2020, FALSE)
results_all_no2020 <- analyze_data(data_all)

# large protests
data_large_no2020 <- feature_transform(protest_large_no_2020, fec_no_2020, FALSE)
results_large_no2020 <- analyze_data(data_large_no2020)

```

The results make sense until we do log transformations to the DV and IV. Why is that? How much of an issue is this? The results with transformations either are not significant... or they are even negative (although coefficients are very close to zero).

Very interesting to see how the results change across different operationalizations for protests.

Table to include (4 columns)
---results for model (no transformations) with no lags
---results for model (no transformations) with lags

figure:
---plot the p-values (and direction for coefficient) across each of the different types of protests

make reference to 2020 exclusion too

NEXT: liberal--> democrat; conservative--> Republican

```{r}
# function to plot coefficients
plot_coeffients <- function(data,title,caption,ylab){
  ggplot(data, aes(x = variable, y = Estimate)) +
  geom_point(size = 2) +
  geom_errorbar(width=.2,size=0.5,aes(ymin = Estimate - (2*Std..Error), ymax = Estimate + (2*Std..Error))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  #scale_y_continuous(labels = percent_format()) +
  theme(axis.text.x = element_text(angle = 30,vjust=0.7)) +
  labs(title = title,
       caption = caption) +
  ylab(ylab) +
  xlab("Model")
}
```

```{r}
title <- "The Effect of Protests on Weekly County-Level FEC Donations (2017-2020)"
caption <- str_wrap("Note: All models include county and week fixed effects as well as lagged number of donations.",54)
ylab <- "Percent Increase in FEC Donations (US Dollars)"
coefficients_logdviv_amount$Protest_Effect <- as.numeric(coefficients_logdviv_amount$Protest_Effect)
coefficients_logdviv_amount$SE <- as.numeric(coefficients_logdviv_amount$SE)
plot_coeffients(coefficients_logdviv_amount,title, caption,ylab)
```




# Analysis III: Diff-in-Diff (day)


