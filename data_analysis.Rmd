---
title: "Rallying for Change: The Effect of Protests on Political Fundraising in the U.S. (Data Analysis)"
author: "Nick Pangakis and Dan Gillion"
output: 
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '4'
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
editor_options: 
  chunk_output_type: inline
---

# Overview - Data Analysis

How do protests influence American political behavior? This project investigates how political protests affect an individual's willingness to donate money to a federal political campaign. In this markdown, I describe the data analyses associated with this project. 

\pagebreak

```{r setup}
knitr::opts_chunk$set(echo = TRUE, fig.width=8, fig.height=4, include=TRUE, eval=TRUE)
options(scipen = 0, digits = 3)  # controls base R output
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(plm, tidyverse, RCurl, here,
               data.table, bit64, stringr,
               readxl, tidyr, usmap, zoo,
               lubridate, scales, fixest,
               gridExtra, rdd, ggh4x,scales, janitor)
```

### Load data and final cleaning

```{r}
# Load in FEC data
fec_daily <- fread("fec_daily.csv") 

# Load in protest data
protest_data <- fread("protest_data.csv") %>% 
    mutate(TRANSACTION_DT = as.character(date),
        # create year variable
        year = as.numeric(str_sub(TRANSACTION_DT, 1, 4)),
        date = as.Date(date)) %>% 
  select(-TRANSACTION_DT) %>% 
  mutate(fips_code = as.character(fips_code),
         fips_code = case_when(
              nchar(fips_code) == 4 ~ paste0("0", fips_code),
              TRUE ~ fips_code))

### Final Data Wrangling - FEC 
fec_daily <- fec_daily %>% 
  mutate(date = as.Date(date),
         month = month(date),
         week = week(date),
         week_in_month = week - week(floor_date(date, unit = "month")) + 1,
         end_of_month = case_when(week_in_month == 5 | week_in_month == 6 ~ 1, 
                                  TRUE ~ 0),
         day_of_week = wday(date, label = TRUE),
         end_of_week = case_when(day_of_week == "Sat" | day_of_week == "Sun" ~ 1, 
                                  TRUE ~ 0)) %>% 
  mutate(fips_code = as.character(fips_code),
         fips_code = case_when(
              nchar(fips_code) == 4 ~ paste0("0", fips_code),
              TRUE ~ fips_code))
```

### Helper functions

```{r}
# Function to create lags and leads

clean_data <- function(data, protests, number_of_lags, number_of_leads, dv_lags){
  for(i in 1:number_of_lags){
    data <- mutate(data, 
                   !!paste0("lag_protest_", i) := lag({{protests}}, 
                                                      n=i, 
                                                      order_by = fips_code))
  }
  
  for(i in 1:number_of_leads){
    data <- mutate(data, 
                   !!paste0("lead_protest_", i) := lead({{protests}}, 
                                                        n=i, 
                                                        order_by = fips_code))
  }
  
  for(i in 1:dv_lags){
    data <- mutate(data, 
                   !!paste0("lag_donation_count_", i) := lag(number_donations, 
                                                             n=i, order_by = fips_code))
    
    data <- mutate(data, !!paste0("lag_donation_amount_", i) := lag(amount_donations, 
                                                                    n=i, 
                                                                    order_by = fips_code))
  } 
  
  data <- data %>% 
    replace(is.na(.), 0)
  
  return(data)
}


get_formulas <- function(dv, dv_lag_name, protest,
                         dv_lags, num_lags_leads){

  # Create lag and lead variable names
  lag_dvs <- paste0("log(",dv_lag_name,"_", 1:dv_lags,"+1)")
  neighbor <- "log(protests_neighbor+1)"
  lag_vars <- paste0("log(lag_protest_", num_lags_leads:1,"+1)")
  protest <- paste0("log(",protest,"+1)")
  lead_vars <- paste0("log(lead_protest_", 1:num_lags_leads,"+1)")
  fe <- "| factor(fips_code) + factor(year) + factor(end_of_week) + factor(month) + factor(end_of_month)"
  
  # Generate the lag and lead portion of the formula
  lag_lead_formula <- paste(c(lag_dvs,neighbor, lag_vars, protest, lead_vars), collapse = " + ")
  
  # Create the complete formula string
  formula_str <- paste0("log(",dv,"+1)", "~", lag_lead_formula, fe)
  
  return(formula_str)
  
}

return_coefficients <- function(summary_data, n_t, model_type, second_facet, dv_lags){

  length_mat <- 2 * n_t + 1
  input_mat <- matrix(nrow = length_mat, ncol = 5)
  
  # Model type
  input_mat[, 1] <- model_type
  
  # second_facet
  input_mat[, 5] <- second_facet
  
  # create time periods
  time_periods <- c()
  for (i in (n_t):-n_t) {
    if (i < 0) {
      time_periods <- c(time_periods, paste0("t", i))
    } else if (i > 0) {
      time_periods <- c(time_periods, paste0("t+", i))
    } else {
      time_periods <- c(time_periods, "t0")
    }
  }
  
  for (i in 1:length_mat) {
    # time period
    input_mat[i, 2] <- time_periods[i]
    # Effect
    input_mat[i, 3] <- round(summary_data[[i + 1+ dv_lags, 1]], 3)
    
    # Standard Error
    input_mat[i, 4] <- round(summary_data[[i + 1+ dv_lags, 2]], 3)
  }
  
  colnames(input_mat) <- c("model","protest", "effect", "se","second_facet")

  
  out <- as.data.frame(input_mat)
  out$effect <- as.numeric(out$effect)
  out$se <- as.numeric(out$se)
  out$protest <- factor(out$protest, levels = c(paste0("t", -n_t:0), paste0("t+", 1:n_t)))
  
  return(out)
}


# Function to get cumulative effects
delta_effects <- function(model,type_of_effect){
    #lag_protest or lead_protest
  if (type_of_effect == "lag_protest"){
    se_cumulative <- as.data.frame(vcov(model)) %>% 
      clean_names() %>% 
      rownames_to_column(var = "rowname") %>% 
      filter(grepl("lag_protest|log\\(protests", rowname)) %>% 
      select(contains("lag_protest"), log_protests_1) %>% 
      as.matrix() %>% 
      sum() %>% 
      sqrt()
    
    beta_sum <- as.data.frame(summary(model)[["coeftable"]]) %>% 
      rownames_to_column(var = "rowname") %>% 
      filter(grepl("lag_protest|log\\(protests", rowname)) %>%
      summarize(sum = sum(Estimate)) %>% 
      pull(1)
  } else {
    se_cumulative <- as.data.frame(vcov(model)) %>% 
      clean_names() %>% 
      rownames_to_column(var = "rowname") %>% 
      filter(grepl("lead_protest", rowname)) %>% 
      select(contains("lead_protest")) %>% 
      as.matrix() %>% 
      sum() %>% 
      sqrt()
    
    beta_sum <- as.data.frame(summary(model)[["coeftable"]]) %>% 
      rownames_to_column(var = "rowname") %>% 
      filter(grepl("lead_protest", rowname)) %>%
      summarize(sum = sum(Estimate)) %>% 
      pull(1)
  }
  
  t_statistic <- beta_sum / se_cumulative
  df <- model[["nobs"]] - model[["nparams"]]
  p_value <- 2 * pt(abs(t_statistic), df = df, lower.tail = FALSE)
  
  print(type_of_effect)
  print(paste("effect:", round(beta_sum,4)))
  print(paste("p-value:", p_value))
}

```

### Get neighbors

```{r}
# # get neighbors
library(sf)
library(spdep)
library(purrr)

# create county neighbor matrix
counties <- st_read("cb_2018_us_county_5m.shp")
sp_nbs <- poly2nb(pl        = counties,
                  queen     = TRUE)
sp_w_binary <- nb2mat(neighbours = sp_nbs,
                      style      = "B",
                      zero.policy = T)
colnames(sp_w_binary) <- counties$GEOID
rownames(sp_w_binary) <- counties$GEOID
sp_w_binary <- sp_w_binary[rownames(sp_w_binary) %in% fec_daily$fips_code,]
sp_w_binary <- sp_w_binary[,colnames(sp_w_binary) %in% fec_daily$fips_code]

# Create an empty dataframe with columns for county and neighbor names
max_neighbors <- 14
neighbor_df <- data.frame(county = character(), 
                          matrix(character(), 
                                 nrow = 0, ncol = max_neighbors, 
                                 dimnames = list(NULL, 
                                                 paste0("neighbor",
                                                        1:max_neighbors))))

# Iterate through each row of the neighbor matrix
for (i in 1:nrow(sp_w_binary)) {
  # Get the neighboring county indices for the current county
  neighbor_indices <- which(sp_w_binary[i, ] == 1)
  
  # Get the neighboring county names
  neighbor_names <- colnames(sp_w_binary)[neighbor_indices]
  
  # Create a new row with the county and its neighboring county names
  new_row <- c(rownames(sp_w_binary)[i], neighbor_names)
  
  # Append NA values if there are fewer neighbors than max_neighbors
  if (length(neighbor_indices) < max_neighbors) {
    extra_neighbors <- rep(NA, max_neighbors - length(neighbor_indices))
    new_row <- c(new_row, extra_neighbors)
  }
  
  # Add the new row to the neighbor dataframe
  neighbor_df <- rbind(neighbor_df, new_row)
}

colnames(neighbor_df) <-  c("county", paste0("neighbor", 1:max_neighbors))

rm(counties,sp_nbs,sp_w_binary,extra_neighbors,new_row,neighbor_names,max_neighbors,neighbor_indices)
```

```{r}
get_neighbors <- function(data){

  data <- data %>% 
    left_join(neighbor_df, by = c("fips_code" = "county"))
  
  fec_neighbor <- data %>%
    left_join(select(data, date, fips_code, 
                     number_donations, amount_donations, protests), 
              by = c("date",   "neighbor1" = "fips_code")) %>%
    rename(amount_donations_neighbor1 = amount_donations.y,
           number_donations_neighbor1 = number_donations.y,
           protests_neighbor1 = protests.y,
           amount_donations_original = amount_donations.x,
           number_donations_original = number_donations.x,
           protests_original = protests.x) %>%
    left_join(select(data, date, fips_code, 
                     number_donations, amount_donations, protests), 
              by = c("date",   "neighbor2" = "fips_code")) %>%
    rename(amount_donations_neighbor2 = amount_donations,
           number_donations_neighbor2 = number_donations,
           protests_neighbor2 = protests) %>%
    left_join(select(data, date, fips_code, 
                     number_donations, amount_donations, protests), 
              by = c("date",   "neighbor3" = "fips_code")) %>%
    rename(amount_donations_neighbor3 = amount_donations,
           number_donations_neighbor3 = number_donations,
           protests_neighbor3 = protests) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor4" = "fips_code")) %>%
    rename(
      amount_donations_neighbor4 = amount_donations,
      number_donations_neighbor4 = number_donations,
      protests_neighbor4 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor5" = "fips_code")) %>%
    rename(
      amount_donations_neighbor5 = amount_donations,
      number_donations_neighbor5 = number_donations,
      protests_neighbor5 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor6" = "fips_code")) %>%
    rename(
      amount_donations_neighbor6 = amount_donations,
      number_donations_neighbor6 = number_donations,
      protests_neighbor6 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor7" = "fips_code")) %>%
    rename(
      amount_donations_neighbor7 = amount_donations,
      number_donations_neighbor7 = number_donations,
      protests_neighbor7 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor8" = "fips_code")) %>%
    rename(
      amount_donations_neighbor8 = amount_donations,
      number_donations_neighbor8 = number_donations,
      protests_neighbor8 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor9" = "fips_code")) %>%
    rename(
      amount_donations_neighbor9 = amount_donations,
      number_donations_neighbor9 = number_donations,
      protests_neighbor9 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor10" = "fips_code")) %>%
    rename(
      amount_donations_neighbor10 = amount_donations,
      number_donations_neighbor10 = number_donations,
      protests_neighbor10 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor11" = "fips_code")) %>%
    rename(
      amount_donations_neighbor11 = amount_donations,
      number_donations_neighbor11 = number_donations,
      protests_neighbor11 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor12" = "fips_code")) %>%
    rename(
      amount_donations_neighbor12 = amount_donations,
      number_donations_neighbor12 = number_donations,
      protests_neighbor12 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor13" = "fips_code")) %>%
    rename(
      amount_donations_neighbor13 = amount_donations,
      number_donations_neighbor13 = number_donations,
      protests_neighbor13 = protests
    ) %>%
    left_join(select(data, date, fips_code, 
                   number_donations, amount_donations, protests), 
            by = c("date", "neighbor14" = "fips_code")) %>%
    rename(
      amount_donations_neighbor14 = amount_donations,
      number_donations_neighbor14 = number_donations,
      protests_neighbor14 = protests
    ) 

  fec_neighbor$amount_donations_neighbor <- rowSums(fec_neighbor[, 
                                           grepl("amount_donations_neighbor", colnames(fec_neighbor))], 
                                        na.rm = TRUE)
  fec_neighbor$number_donations_neighbor <- rowSums(fec_neighbor[, 
                                           grepl("number_donations_neighbor", colnames(fec_neighbor))], 
                                        na.rm = TRUE)
  fec_neighbor$protests_neighbor <- rowSums(fec_neighbor[, 
                                   grepl("protests_neighbor", colnames(fec_neighbor))], 
                                na.rm = TRUE)



  fec_neighbor <- fec_neighbor %>% 
    select(fips_code, date, year, end_of_month, end_of_week, month,
           number_donations = number_donations_original, 
           amount_donations = amount_donations_original,
           protests = protests_original,amount_donations_neighbor, 
         number_donations_neighbor, protests_neighbor) 
  
  return(fec_neighbor)
}

```

## test # of lags?

```{r}
# test number of DV lags to include... can't get it to work

# pGrunfeld <- pdata.frame(Grunfeld, index = c("firm", "year"))
# purtest(pGrunfeld$inv, pmax = 4, exo = "intercept", test = "madwu")
# 
# fec_size_main_pdata <- pdata.frame(fec_size_main, index = c("fips_code", "date"))
# purtest(fec_size_main_pdata$amount_donations, pmax = 4, exo = "intercept", test = "madwu")
# # detach(package:plm, unload = TRUE)

```

# Analysis I: DiD

```{r}
# protest size
fec_main <- fec_daily %>% 
  arrange(fips_code, date) %>% 
  group_by(fips_code, date, year, end_of_month, end_of_week, month) %>% 
  summarize(number_donations = sum(number_donations),
            amount_donations = sum(amount_donations),
            protests = sum(protests_size_all)) %>% 
  ungroup() 

# # protest size - lib protest
# fec_main_lib <- fec_daily %>% 
#   arrange(fips_code, date) %>% 
#   group_by(fips_code, date, year, end_of_month, end_of_week, month) %>% 
#   summarize(number_donations = sum(number_donations),
#             amount_donations = sum(amount_donations),
#             protests = sum(protests_size_liberal)) %>% 
#   ungroup() 
# 
# # protest size - con protest
# fec_main_con <- fec_daily %>% 
#   arrange(fips_code, date) %>% 
#   group_by(fips_code, date, year, end_of_month, end_of_week, month) %>% 
#   summarize(number_donations = sum(number_donations),
#             amount_donations = sum(amount_donations),
#             protests = sum(protests_size_conservative)) %>% 
#   ungroup() 
```

```{r}
########## final cleaning

##### Clean data: main
fec_neighbor <- get_neighbors(fec_main)
dv_lags <- 2
num_lags_leads <- 3
fec_main_analyze <- clean_data(fec_neighbor, protests, num_lags_leads, num_lags_leads, dv_lags)
# ##### Clean data: lib
# fec_main_lib <- get_neighbors(fec_main_lib)
# fec_main_lib <- clean_data(fec_main_lib, protests, 3, 3, 2)
# ##### Clean data: con
# fec_main_con <- get_neighbors(fec_main_con)
# fec_main_con <- clean_data(fec_main_con, protests, 3, 3, 2)
```


## Main effects of protests
```{r}
######### Fit models

#  dv:Amt
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("amount_donations", "lag_donation_amount",
             "protests",dv_lags, num_lags_leads)
model_amt <- feols(as.formula(formula_str), data = fec_main_analyze)

# dv: count
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("number_donations", "lag_donation_count",
             "protests",dv_lags, num_lags_leads)
model_count <- feols(as.formula(formula_str), data = fec_main_analyze)

# #  lib protest dv:Amt
# dv_lags <- 2
# num_lags_leads <- 3
# formula_str <- get_formulas("amount_donations", "lag_donation_amount",
#              "protests",dv_lags, num_lags_leads)
# model_amt_lib <- feols(as.formula(formula_str), data = fec_main_lib)
# 
# # lib protest dv: count
# dv_lags <- 2
# num_lags_leads <- 3
# formula_str <- get_formulas("number_donations", "lag_donation_count",
#              "protests",dv_lags, num_lags_leads)
# model_count_lib <- feols(as.formula(formula_str), data = fec_main_lib)
# 
# #  con protest dv:Amt
# dv_lags <- 2
# num_lags_leads <- 3
# formula_str <- get_formulas("amount_donations", "lag_donation_amount",
#              "protests",dv_lags, num_lags_leads)
# model_amt_con <- feols(as.formula(formula_str), data = fec_main_con)
# 
# # con protest dv: count
# dv_lags <- 2
# num_lags_leads <- 3
# formula_str <- get_formulas("number_donations", "lag_donation_count",
#              "protests",dv_lags, num_lags_leads)
# model_count_con <- feols(as.formula(formula_str), data = fec_main_con)

```

```{r}

########## All Protests
# model_amt
size_results_amt_loglog <- summary(model_amt)[["coeftable"]]
size_results_amt_loglog <- return_coefficients(size_results_amt_loglog, 5, 
                                               "Logged Daily Donation Amount in a County", 
                                     "All Protests", 2)
print(paste("protest_attendees:",sum(fec_main$protests)))
delta_effects(model_amt,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.0132"
# [1] "p-value: 0.101852859507681"
delta_effects(model_amt,"lead_protest")
# [1] "lead_protest"
# [1] "effect: 0.003"
# [1] "p-value: 0.62234260832175"

# name                              Estimate Std. Error t value Pr(>|t|)
# log(protests_neighbor + 1)      0.004349    0.00152   2.855 4.34e-03

# model_count
size_results_ct_loglog <- summary(model_count)[["coeftable"]]
size_results_ct_loglog <- return_coefficients(size_results_ct_loglog, 5, 
                                              "Logged Daily Number of Donations in a County", 
                                     "All Protests", 2)
print(paste("protest_attendees:",sum(fec_main$protests)))
delta_effects(model_count,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.0072"
# [1] "p-value: 0.00302682581146318"
delta_effects(model_count,"lead_protest")
# [1] "lead_protest"
# [1] "effect: 0.009"
# [1] "p-value: 2.48101743372211e-06"


# name                              Estimate Std. Error t value Pr(>|t|)
# log(protests_neighbor + 1)     0.00109   0.000448    2.42 1.54e-02


# ########## Liberal Protests
# 
# # model_amt
# size_results_amt_logloglib <- summary(model_amt_lib)[["coeftable"]]
# size_results_amt_logloglib <- return_coefficients(size_results_amt_logloglib, 3, 
#                                                "Logged Daily Donation Amount in a County", 
#                                      "Liberal Protests", 2)
# print(paste("protest_attendees:",sum(fec_main_lib$protests)))
# delta_effects(model_amt_lib,"lag_protest")
# 
# delta_effects(model_amt_lib,"lead_protest")
# 
# # model_count
# size_results_ct_logloglib <- summary(model_count_lib)[["coeftable"]]
# size_results_ct_logloglib <- return_coefficients(size_results_ct_logloglib, 3, 
#                                               "Logged Daily Number of Donations in a County", 
#                                      "Liberal Protests", 2)
# print(paste("protest_attendees:",sum(fec_main_lib$protests)))
# delta_effects(model_count_lib,"lag_protest")
# 
# delta_effects(model_count_lib,"lead_protest")
# 
# 
# ########## Conservative Protests
# 
# # model_amt
# size_results_amt_loglogcon <- summary(model_amt_con)[["coeftable"]]
# size_results_amt_loglogcon <- return_coefficients(size_results_amt_loglogcon, 3, 
#                                                "Logged Daily Donation Amount in a County", 
#                                      "Conservative Protests", 2)
# print(paste("protest_attendees:",sum(fec_main_con$protests)))
# delta_effects(model_amt_con,"lag_protest")
# 
# delta_effects(model_amt_con,"lead_protest")
# 
# # model_count
# size_results_ct_loglogcon <- summary(model_count_con)[["coeftable"]]
# size_results_ct_loglogcon <- return_coefficients(size_results_ct_loglogcon, 3, 
#                                               "Logged Daily Number of Donations in a County", 
#                                      "Conservative Protests", 2)
# print(paste("protest_attendees:",sum(fec_main_con$protests)))
# delta_effects(model_count_con,"lag_protest")
# 
# delta_effects(model_count_con,"lead_protest")
# 
# 




# combine
size_plot_results <- rbind(size_results_amt_loglog,size_results_ct_loglog)
```

```{r}
# plot 
main_plot <- size_plot_results %>% 
 ggplot(aes(y = effect, x = protest)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = effect - (2*se), ymax = effect + (2*se)),width=.1
                ) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  labs(title=str_wrap("The Effect of Protests on US Donation Behavior",35),
       y= "Increase in Federal Donations",
       x="Days from Protest Event",
       caption = str_wrap("Note: Independent variable is logged number of daily protest attendees in a county. Regression coefficients are estimates from a staggered difference-in-differences design with county and temporal fixed-effects. Additional controls include (logged) donations lagged from the previous two days and (logged) number of protest attendees in neighboring counties. Error bars are 95% confidence intervals.",110)) +
  theme_bw() + # Set the heights of the panels)
  facet_wrap(~model, nrow=2, scales = "free_y") +
  theme(plot.title = element_text(hjust=0.5),
        text = element_text(size=12),
        legend.position="top") +
  # scale_x_discrete(labels = function(x) str_wrap(x, width = 8)) +
  facetted_pos_scales(
    y = list(
      model == "Logged Daily Donation Amount in a County" ~ scale_y_continuous(labels = scales::percent_format(),
                                                                               limits = c(-0.01, .015)),
      model == "Logged Daily Number of Donations in a County" ~ scale_y_continuous(labels = scales::percent_format(),
                                                                                   limits = c(-0.01, .015))
    )
  ) +
    geom_vline(xintercept = c(4), 
             color = "blue", linetype = "dashed", alpha = .6)
```

```{r}
pdf("main_plot.pdf")
print(main_plot)    
dev.off() 
```

## Ideological effects

```{r}
### Dealing with missing values
# Since not every date has a donation in every county, not every date-county pair populates. 
county_date_pairs <- fec_daily %>% 
  group_by(date, fips_code, year, month, end_of_month, end_of_week) %>% 
  summarize(amount_donations = sum(amount_donations),
            number_donations = sum(number_donations)
            ) %>% 
  select(number_donations, amount_donations, date, fips_code, year, month, end_of_month, end_of_week) %>% 
  arrange(fips_code, date) %>% 
  mutate(protests_liberal=0, protests_conservative=0, 
         protests_racial=0, protests_women=0,
         protests_size_liberal=0, protests_size_conservative=0,
         protests_size_racial=0, protests_size_women=0)

ideological_protest <- function(filter_var, grouping_var, protests){
  data_out <- fec_daily %>% 
    filter({{filter_var}} != 1, {{grouping_var}} == 1) %>% 
    arrange(fips_code, date) %>% 
    select(date, fips_code, year, month, end_of_month, end_of_week, 
           number_donations, amount_donations, {{protests}})
  
  missing_check <- county_date_pairs %>% 
    select({{protests}}, date, fips_code, year, 
           month, end_of_month, end_of_week, amount_donations, number_donations)
    
  # Find missing date-county pair
  missing <- anti_join(missing_check, 
                       data_out[,c("date","fips_code", "year",
                                   "month", "end_of_month", "end_of_week")])
  data_out <- rbind(data_out,missing)
  
  data_out <- data_out %>% 
    arrange(fips_code, date) %>% 
    group_by(fips_code, date, year, end_of_month, 
             end_of_week, month) %>% 
    summarize(amount_donations = sum(amount_donations),
              number_donations = sum(number_donations)
              ) %>% 
    ungroup()
  
  protest_new <- protest_data %>% 
    select(protests = {{protests}},date,fips_code,year)
  
  # add protests back in 
  data_out <- data_out %>% 
    left_join(protest_new, by = c("date","fips_code","year"))
  
  data_out <- get_neighbors(data_out)
  data_out <- clean_data(data_out, protests, 5, 5, 2)
  
    return(data_out)
}

##### Protest size
# valence
lib_dem <- ideological_protest(no_party,dem,protests_size_liberal)
lib_rep <- ideological_protest(no_party,rep,protests_size_liberal)
rep_dem <- ideological_protest(no_party,dem,protests_size_conservative)
rep_rep <- ideological_protest(no_party,rep,protests_size_conservative)
# # racial
# race_dem <- ideological_protest(no_party,dem,protests_size_racial)
# race_rep <- ideological_protest(no_party,rep,protests_size_racial)
# # women
# women_dem <- ideological_protest(no_party,dem,protests_size_women)
# women_rep <- ideological_protest(no_party,rep,protests_size_women)

```

```{r}
########### Ideological protests

###### 1) lib_dem

# dv: amt
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("amount_donations", "lag_donation_amount",
             "protests",dv_lags, num_lags_leads)
model9 <- feols(as.formula(formula_str), data = lib_dem)

# dv: count
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("number_donations", "lag_donation_count",
             "protests",dv_lags, num_lags_leads)
model9b <- feols(as.formula(formula_str), data = lib_dem)


###### 2) lib_rep

# dv: amt
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("amount_donations", "lag_donation_amount",
             "protests",dv_lags, num_lags_leads)
model10 <- feols(as.formula(formula_str), data = lib_rep)

# dv: count
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("number_donations", "lag_donation_count",
             "protests",dv_lags, num_lags_leads)
model10b <- feols(as.formula(formula_str), data = lib_rep)

###### 3) rep_dem

# dv: amt
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("amount_donations", "lag_donation_amount",
             "protests",dv_lags, num_lags_leads)
model11 <- feols(as.formula(formula_str), data = rep_dem)

# dv: count
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("number_donations", "lag_donation_count",
             "protests",dv_lags, num_lags_leads)
model11b <- feols(as.formula(formula_str), data = rep_dem)


###### 4) rep_rep

# dv: amt
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("amount_donations", "lag_donation_amount",
             "protests",dv_lags, num_lags_leads)
model12 <- feols(as.formula(formula_str), data = rep_rep)

# dv: count
dv_lags <- 2
num_lags_leads <- 3
formula_str <- get_formulas("number_donations", "lag_donation_count",
             "protests",dv_lags, num_lags_leads)
model12b <- feols(as.formula(formula_str), data = rep_rep)

```

```{r}

###### 1) lib_dem
# DV: Amt
lib_dem_results <- summary(model9)[["coeftable"]]
lib_dem_results <- return_coefficients(lib_dem_results,3,
                                       "Logged Daily Donation Amount to D's",
                                       "Liberal Protests",2)
print(paste("protest_attendees:",sum(lib_dem$protests)))
delta_effects(model9,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.0095"
# [1] "p-value: 0.185946208304612"
delta_effects(model9,"lead_protest")
# [1] "lead_protest"
# [1] "effect: 0.0019"
# [1] "p-value: 0.722240930536966"

# DV: Count
lib_dem_results_count <- summary(model9b)[["coeftable"]]
lib_dem_results_count <- return_coefficients(lib_dem_results_count,3,
                                       "Logged Daily Number of Donations to D's",
                                       "Liberal Protests", 2)
delta_effects(model9b,"lag_protest")
# [1] "lag_protest"
# [1] "effect: -0.0129"
# [1] "p-value: 0.000238189946440448"

delta_effects(model9b,"lead_protest")
# [1] "lead_protest"
# [1] "effect: -0.0094"
# [1] "p-value: 0.00021544380626703"


###### 2) lib_rep
# DV: Amt
lib_rep_results <- summary(model10)[["coeftable"]]
lib_rep_results <- return_coefficients(lib_rep_results,3,
                                       "Logged Daily Donation Amount to R's",
                                       "Liberal Protests",2)
print(paste("protest_attendees:",sum(lib_rep$protests)))
delta_effects(model10,"lag_protest")
# [1] "lag_protest"
# [1] "effect: -0.0051"
# [1] "p-value: 0.31234121691662"
delta_effects(model10,"lead_protest")
# [1] "lead_protest"
# [1] "effect: -0.0023"
# [1] "p-value: 0.5772562113286"

# DV: Count
lib_rep_results_count <- summary(model10b)[["coeftable"]]
lib_rep_results_count <- return_coefficients(lib_rep_results_count,3,
                                       "Logged Daily Number of Donations to R's",
                                       "Liberal Protests", 2)
delta_effects(model10b,"lag_protest")
# [1] "lag_protest"
# [1] "effect: -0.0259"
# [1] "p-value: 3.00843682022018e-36"

delta_effects(model10b,"lead_protest")
# [1] "lead_protest"
# [1] "effect: -0.007"
# [1] "p-value: 9.00976685241807e-05"

###### 3) rep_dem
# DV: Amt
rep_dem_results <- summary(model11)[["coeftable"]]
rep_dem_results <- return_coefficients(rep_dem_results,3,
                                       "Logged Daily Donation Amount to D's",
                                       "Conservative Protests",2)
print(paste("protest_attendees:",sum(rep_dem$protests)))
delta_effects(model11,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.0586"
# [1] "p-value: 1.36939333770304e-13"
delta_effects(model11,"lead_protest")
# [1] "lead_protest"
# [1] "effect: 0.033"
# [1] "p-value: 2.05753953101128e-06"

# DV: Count
rep_dem_results_count <- summary(model11b)[["coeftable"]]
rep_dem_results_count <- return_coefficients(rep_dem_results_count,3,
                                       "Logged Daily Number of Donations to D's",
                                       "Conservative Protests", 2)
delta_effects(model11b,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.0586"
# [1] "p-value: 1.36939333770304e-13"

delta_effects(model11b,"lead_protest")
# [1] "lead_protest"
# [1] "effect: 0.033"
# [1] "p-value: 2.05753953101128e-06"

###### 4) rep_rep
# DV: Amt
rep_rep_results <- summary(model12)[["coeftable"]]
rep_rep_results <- return_coefficients(rep_rep_results,3,
                                       "Logged Daily Donation Amount to R's",
                                       "Conservative Protests",2)
print(paste("protest_attendees:",sum(rep_rep$protests)))
delta_effects(model12,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.0199"
# [1] "p-value: 0.13810117364365"
delta_effects(model12,"lead_protest")
# [1] "lead_protest"
# [1] "effect: -0.0075"
# [1] "p-value: 0.521987197029576"

# DV: Count
rep_rep_results_count <- summary(model12b)[["coeftable"]]
rep_rep_results_count <- return_coefficients(rep_rep_results_count,3,
                                       "Logged Daily Number of Donations to R's",
                                       "Conservative Protests", 2)
delta_effects(model12b,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.035"
# [1] "p-value: 5.92430708281838e-08"

delta_effects(model12b,"lead_protest")
# [1] "lead_protest"
# [1] "effect: 0.037"
# [1] "p-value: 2.80018218049985e-13"


ideological_plot_results <- rbind(lib_dem_results, lib_rep_results,
                                  rep_dem_results, rep_rep_results,
                                  
                                  lib_dem_results_count,rep_dem_results_count,
                                  rep_rep_results_count, lib_rep_results_count
                                  )
```

```{r}
# plot 
ideological_plot <- ideological_plot_results %>%
 ggplot(aes(y = effect, x = protest, color = second_facet)) +
  geom_point(size = 2,position=position_dodge(width=0.5)) +
  geom_errorbar(aes(ymin = effect - (2*se), ymax = effect + (2*se)),width=.1,
                position=position_dodge(width=0.5)
                ) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  labs(title=str_wrap("The Ideological Effect of Protests on US Donation Behavior",35),
       y= "Increase in Federal Donations",
       x="Days from Protest Event",
       caption = str_wrap("Note: Independent variable is logged number of daily protest attendees in a county. Regression coefficients are estimates from a staggered difference-in-differences design with county and temporal fixed-effects. Additional controls include (logged) donations lagged from the previous two days and (logged) number of protest attendees in neighboring counties. Error bars are 95% confidence intervals.",110)) +
  theme_bw() + # Set the heights of the panels)
  facet_wrap(~model, nrow=2, scales = "free_y") +
  theme(plot.title = element_text(hjust=0.5),
        text = element_text(size=12),
        legend.position="top") +
  labs(color = "Type of Protest") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) +
  scale_y_continuous(labels = scales::percent_format(),
                     limits = c(-0.025, .03)) +
  scale_color_manual(values = c("red", "blue", "green","black")) +
    geom_vline(xintercept = c(4), 
             color = "blue", linetype = "dashed", alpha = .6)

```

```{r}
pdf("ideological_results.pdf")
print(ideological_plot)    
dev.off() 
```

## Effects on Neighbors

```{r}

fec_main_neighbor <- fec_main_analyze %>% 
  mutate(nlag_protest_1 = lag(protests_neighbor, 
                             n=1, 
                             order_by =fips_code),
         nlag_protest_2 = lag(protests_neighbor, 
                             n=2, 
                             order_by =fips_code),
         nlag_protest_3 = lag(protests_neighbor, 
                             n=3, 
                             order_by =fips_code),
         nlead_protest_1 = lead(protests_neighbor, 
                             n=1, 
                             order_by =fips_code),
         nlead_protest_2 = lead(protests_neighbor, 
                             n=2, 
                             order_by =fips_code),
         nlead_protest_3 = lead(protests_neighbor, 
                             n=3, 
                             order_by =fips_code),
         lag_donation_amount_1 = lag(amount_donations_neighbor, 
                             n=1, 
                             order_by =fips_code),
         lag_donation_amount_2 = lag(amount_donations_neighbor, 
                             n=2, 
                             order_by =fips_code),
         lag_donation_count_1 = lag(number_donations_neighbor, 
                             n=1, 
                             order_by =fips_code),
         lag_donation_count_2 = lag(number_donations_neighbor, 
                             n=2, 
                             order_by =fips_code))

```





```{r}

#  dv:Amt
formula_str <- "log(amount_donations_neighbor+1)~log(lag_donation_amount_1+1) + log(lag_donation_amount_2+1) + log(protests+1) + log(nlag_protest_3+1) + log(nlag_protest_2+1) + log(nlag_protest_1+1) + log(protests_neighbor+1) + log(nlead_protest_1+1) + log(nlead_protest_2+1) + log(nlead_protest_3+1)| factor(fips_code) + factor(year) + factor(end_of_week) + factor(month) + factor(end_of_month)"
model_amt <- feols(as.formula(formula_str), data = fec_main_neighbor)

# dv: count
formula_str <- "log(number_donations_neighbor+1)~log(lag_donation_count_1+1) + log(lag_donation_count_2+1) + log(protests+1) + log(nlag_protest_3+1) + log(nlag_protest_2+1) + log(nlag_protest_1+1) + log(protests_neighbor+1) + log(nlead_protest_1+1) + log(nlead_protest_2+1) + log(nlead_protest_3+1)| factor(fips_code) + factor(year) + factor(end_of_week) + factor(month) + factor(end_of_month)"
model_count <- feols(as.formula(formula_str), data = fec_main_neighbor)
```

```{r}
########## All Protests
# model_amt
size_results_amt_loglog <- summary(model_amt)[["coeftable"]]
size_results_amt_loglog <- return_coefficients(size_results_amt_loglog, 3, 
                                               "Logged Daily Donation Amount in Neighboring County", 
                                     "All Protests", 2)
print(paste("protest_attendees:",sum(fec_main$protests)))
delta_effects(model_amt,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.0171"
# [1] "p-value: 2.15680623626951e-11"
delta_effects(model_amt,"lead_protest")
# [1] "lead_protest"
# [1] "effect: -0.015"
# [1] "p-value: 1.96552955771573e-20"

# name                              Estimate Std. Error t value Pr(>|t|)
# log(protests_neighbor + 1)      0.004349    0.00152   2.855 4.34e-03

# model_count
size_results_ct_loglog <- summary(model_count)[["coeftable"]]
size_results_ct_loglog <- return_coefficients(size_results_ct_loglog, 3, 
                                              "Logged Daily Number of Donations in Neighboring County", 
                                     "All Protests", 2)
print(paste("protest_attendees:",sum(fec_main$protests)))
delta_effects(model_count,"lag_protest")
# [1] "lag_protest"
# [1] "effect: 0.003"
# [1] "p-value: 0.000995901918066203"
delta_effects(model_count,"lead_protest")
# [1] "lead_protest"
# [1] "effect: -0.0022"
# [1] "p-value: 0.000268966455829423"


# name                              Estimate Std. Error t value Pr(>|t|)
# log(protests_neighbor + 1)     0.00109   0.000448    2.42 1.54e-02

neighbor_plot_results <- rbind(size_results_amt_loglog, 
                               size_results_ct_loglog)

```

```{r}
# plot 
neighbor_plot <- neighbor_plot_results %>% 
 ggplot(aes(y = effect, x = protest)) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = effect - (2*se), ymax = effect + (2*se)),width=.1
                ) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  labs(title=str_wrap("The Effect of Protests on US Donation Behavior",35),
       y= "Increase in Federal Donations",
       x="Days from Protest Event",
       caption = str_wrap("Note: Independent variable is logged number of daily protest attendees in a county. Regression coefficients are estimates from a staggered difference-in-differences design with county and temporal fixed-effects. Additional controls include (logged) donations lagged from the previous two days and (logged) number of protest attendees in neighboring counties. Error bars are 95% confidence intervals.",110)) +
  theme_bw() + # Set the heights of the panels)
  facet_wrap(~model, nrow=2, scales = "free_y") +
  theme(plot.title = element_text(hjust=0.5),
        text = element_text(size=12),
        legend.position="top") +
  # scale_x_discrete(labels = function(x) str_wrap(x, width = 8)) +
  facetted_pos_scales(
    y = list(
      model == "Logged Daily Donation Amount in Neighboring County" ~ scale_y_continuous(labels = scales::percent_format(),
                                                                               limits = c(-0.01, .015)),
      model == "Logged Daily Number of Donations in Neighboring County" ~ scale_y_continuous(labels = scales::percent_format(),
                                                                                   limits = c(-0.01, .015))
    )
  ) +
    geom_vline(xintercept = c(4), 
             color = "blue", linetype = "dashed", alpha = .6)
```

```{r}
pdf("neighbor.pdf")
print(neighbor_plot)    
dev.off() 
```










# RDD 

```{r}
# Load in march data
fec_march_daily_full <- fread("fec_march_daily_full.csv") 

fec_march_daily_full <- fec_march_daily_full %>% 
  mutate(date = as.Date(date),
         month = month(date),
         week = week(date),
         week_in_month = week - week(floor_date(date, unit = "month")) + 1,
         end_of_month = case_when(week_in_month == 5 | week_in_month == 6 ~ 1, 
                                  TRUE ~ 0),
         day_of_week = wday(date, label = TRUE),
         end_of_week = case_when(day_of_week == "Sat" | day_of_week == "Sun" ~ 1, 
                                  TRUE ~ 0))


```


### Visualize

```{r}
donations_plot <- fec_march_daily_full %>% 
  group_by(fips_code, date,days, after,end_of_month,end_of_week) %>% 
  summarize(amount_donations = sum(amount_donations)) 
  #mutate(amount_donations = log(amount_donations+1))

donations_plot <- donations_plot %>% 
  group_by(days, date, after) %>% 
    summarize(amount_donations = sum(amount_donations)) %>%
  filter(days > -83 & days < 84) %>% 
  mutate(days = as.numeric(days))


# 
# labels <- seq(as.Date("2018-01-01"), as.Date("2018-06-15"),
#                              by = "1 day")
# test <- as.numeric(labels)
# 
# # start_date <- as.Date("2018-01-01")
# # end_date <- as.Date("2018-06-15")
# # labels <- seq(start_date, end_date, by = "1 day")
# breaks <- seq(test, by = 10)
# breaks <- as.character(breaks)


march_plot <- donations_plot %>% 
  ggplot(aes(x = days)) +
  geom_point(aes(x = days, 
          y = amount_donations)) +
  geom_smooth(aes(x = days,
                  y =  amount_donations,
                  linetype = as.factor(after)),
              size = 1, color = "red") +
  theme_bw() +
  geom_vline(xintercept = as.numeric(0), 
             linetype = "longdash",
             alpha = .6,
             color="blue") +
  theme(legend.position = "none") +
  labs(title = str_wrap("Federal Campaign Contributions and the March for Our Lives Protests",45)) +
  scale_x_continuous(breaks = seq(-82,83, by = 15)) + # ,
  scale_y_continuous("Amount of Daily Donations",
                     # breaks = seq(0, 36000000, by = 6000000),
                     # limits = c(0,36000000),
                     labels = scales::dollar_format()) +
  labs(x="Distince (in Days) from March For Our Lives Protests") +
  geom_text(x = 0, y = 0, 
            label = "Date of March For Our Lives Protests", color = "blue", size = 3)
  # theme(axis.text.x = element_text(hjust = 1,
  #                                  angle = 90))


```

```{r}
pdf("march_plot.pdf")
print(march_plot)    
dev.off() 
```



### Window Plot - Donation Amount

```{r}

lout_sub <- feols(amount_donations ~ days*after  | as.factor(fips_code) + as.factor(end_of_month) + as.factor(end_of_week), data=donations_window)


summary(lout_sub)[["coeftable"]]["days:after",]
```


````{r}
##### Visualize regression coefficients over varying windows

donations_window <- fec_march_daily_full %>% 
  filter(days > -121 & days < 121) %>% 
  group_by(fips_code, date,days, after,end_of_month,end_of_week) %>% 
  summarize(amount_donations = sum(amount_donations)) %>% 
  mutate(amount_donations = log(amount_donations+1))

windows <- seq(5,120, by=1)
mat <- matrix(NA, nrow = 116, ncol = 4)
for (i in 1:length(windows)){
  # create varying subset to run regression
  sub_dta <- subset(donations_window,
                    days > 0 - windows[i] & days < 0 + windows[i])
  # fit linear model
  lout_sub <- feols(amount_donations ~ days*after  | as.factor(fips_code) + as.factor(end_of_month) + as.factor(end_of_week), 
                    data=sub_dta)
  
  # extract necessary coefficients
  coefficient <- round(summary(lout_sub)[["coeftable"]][["days:after",1]], 3)
  se <- round(summary(lout_sub)[["coeftable"]][["days:after",2]], 3)
  pvalue <- round(summary(lout_sub)[["coeftable"]][["days:after",4]], 3)
  # add coefficients to plot
  mat[i,1] <- windows[i]
  mat[i,2] <- coefficient
  mat[i,3] <- se
  mat[i,4] <- pvalue
}
colnames(mat) <- c("window_size","coefficient","se","pvalue")
plot_coef <- data.frame(mat)
plot_coef <- plot_coef %>% 
  mutate(significant = case_when(pvalue < 0.051 ~ 1, TRUE ~ 0)) %>% 
  drop_na()

# Calculate optimal bandwidth
bw_amount <- IKbandwidth(X = donations_window$days, 
                        Y = donations_window$amount_donations, cutpoint = 0)
bw_amount_dta <-subset(donations_window, days > 0 - bw_amount & days < 0 + bw_amount)
lout_sub <- feols(amount_donations ~ days*after  | as.factor(fips_code) + as.factor(end_of_month) + as.factor(end_of_week), 
                  data=bw_amount_dta)
summary(lout_sub)[["coeftable"]]

plot_coef$optimal <- 0
plot_coef$optimal <- ifelse(plot_coef$window_size==floor(bw_amount), 1, 0)

# number of significant window sizes
print(nrow(mat[mat[,"pvalue"] < 0.051,]))
# Mean coefficient: 0.005
print(summary(mat[,"coefficient"]))
# mean pvalue: 0.018 
print(summary(mat[,"pvalue"]))
# Plot --------------------------------------------------------------------
window_plot <- ggplot(plot_coef, aes(x = window_size, y = coefficient,color=as.factor(optimal))) +
  geom_point(size = 1) +
  geom_errorbar(aes(ymin = coefficient - (2*se), ymax = coefficient + (2*se))) +
  geom_hline(yintercept = 0,
             linetype = "longdash",
             color = "red") +
  scale_color_manual(values = c("black","red")) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_continuous("Window Size (Days)",
                     breaks = seq(5, 120, by = 10)) +
  labs(title = "Varying Window Sizes:",
       #caption = "Figure 3",
       subtitle = "The Effect of the March for Our Lives Protests on Donation Behavior") +
  ylab("Increase in Federal Donations") #+
  # geom_label(
  #   label=str_wrap("Imbens-Kalyanaraman Optimal Bandwidth: 63 Days Coefficient: $8,052,911, P-Value: 0.018",46), 
  #   x=63,
  #   y=18000000,
  #   label.padding = unit(0.1, "lines"), # Rectangle size around label
  #   label.size = NA,
  #   color = "black",
  #   fill="#56B4E9",
  #   size = 2.5
  # )
```

```{r}
pdf("window_plot.pdf")
print(window_plot)    
dev.off() 
```


All are positively signed. 54 out of 86 bandwidths show statistically significant increases. Mean coefficient is 7234058 and median is 6847223. Mean p-value is 0.08 and the median p-value is 0.03.

